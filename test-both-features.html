<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Both Features - Consider Restoration</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/shared-data.js"></script>
    <script src="js/auth-security.js"></script>
    <script src="js/cookie-session-manager.js"></script>
    <script src="js/navigation-handler.js"></script>
    <style>
        .test-container {
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .status-box {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            border-left: 4px solid #3A7D99;
        }
        .test-section {
            background: #fff;
            border: 2px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .membership-btn {
            background: #3A7D99;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
        }
        .booking-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            box-sizing: border-box;
        }
        .success-indicator {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border: 1px solid #c3e6cb;
            border-radius: 3px;
            margin: 10px 0;
        }
        .error-indicator {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border: 1px solid #f5c6cb;
            border-radius: 3px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-container">
                <h1 class="logo">Consider Restoration</h1>
                <ul class="nav-menu">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="user-portal.html" id="accountNavLink">Login</a></li>
                    <li id="adminNavLink" style="display: none;"><a href="admin.html">Admin</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <div class="test-container">
        <h1>üß™ Test Both User Features</h1>
        
        <div class="status-box">
            <h3>Current Session Status</h3>
            <p id="sessionStatus">Checking...</p>
            <p id="userInfo">Loading user info...</p>
        </div>
        
        <div class="status-box">
            <h3>Quick Actions</h3>
            <button onclick="testLogin()" style="background: #27ae60; color: white; padding: 10px 20px; border: none; border-radius: 3px; margin: 5px; cursor: pointer;">Login as Test User</button>
            <button onclick="testLogout()" style="background: #e74c3c; color: white; padding: 10px 20px; border: none; border-radius: 3px; margin: 5px; cursor: pointer;">Logout</button>
            <button onclick="refreshAll()" style="background: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 3px; margin: 5px; cursor: pointer;">Refresh All Features</button>
        </div>
        
        <div class="test-section">
            <h3>üìÖ Issue #1: Booking Page Auto-Population</h3>
            <div class="booking-form">
                <div class="form-group">
                    <label for="clientName">Full Name:</label>
                    <input type="text" id="clientName" name="clientName" required>
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone:</label>
                    <input type="tel" id="phone" name="phone" required>
                </div>
                <button onclick="testBookingPopulation()" style="background: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 3px; cursor: pointer;">Test Auto-Population</button>
            </div>
            <div id="bookingStatus"></div>
            <p><strong>Expected:</strong> When logged in, fields should auto-fill with light blue background</p>
            <p><a href="booking.html" target="_blank" style="color: #3A7D99;">üîó Test on Real Booking Page</a></p>
        </div>
        
        <div class="test-section">
            <h3>üí≥ Issue #2: Membership Page Join Now Persistence</h3>
            <button class="membership-btn" onclick="simulateJoinNow()">Join Now</button>
            <div id="membershipStatus"></div>
            <p><strong>Expected:</strong> When logged in, button should say "Join Now - [User Name]" and remember login through membership flow</p>
            <p><a href="membership.html" target="_blank" style="color: #3A7D99;">üîó Test on Real Membership Page</a></p>
        </div>
        
        <div class="status-box">
            <h3>üîß Debug Information</h3>
            <div id="debugInfo">Loading...</div>
        </div>
        
        <div class="status-box">
            <h3>üìù Test Instructions</h3>
            <ol>
                <li>Click "Login as Test User" above</li>
                <li>Verify booking fields auto-populate with blue background</li>
                <li>Verify membership button shows "Join Now - Test User"</li>
                <li>Test real pages using the links above</li>
                <li>On membership page, complete the Join Now flow and verify you stay logged in</li>
            </ol>
        </div>
    </div>

    <script>
        function updateStatus() {
            const sessionStatus = document.getElementById('sessionStatus');
            const userInfo = document.getElementById('userInfo');
            const debugInfo = document.getElementById('debugInfo');
            
            try {
                if (typeof window.CookieSessionManager === 'undefined') {
                    sessionStatus.textContent = 'CookieSessionManager not loaded';
                    return;
                }
                
                const currentUser = window.CookieSessionManager.getCurrentUser();
                
                if (currentUser) {
                    sessionStatus.innerHTML = `‚úÖ <strong>Logged in as ${currentUser.name}</strong>`;
                    userInfo.innerHTML = `
                        <strong>User Details:</strong><br>
                        Email: ${currentUser.email}<br>
                        Phone: ${currentUser.phone || 'Not provided'}<br>
                        Role: ${currentUser.role}
                    `;
                } else {
                    sessionStatus.textContent = '‚ùå Not logged in';
                    userInfo.textContent = 'No user session found';
                }
                
                debugInfo.innerHTML = `
                    <strong>System Status:</strong><br>
                    CookieSessionManager: ${typeof window.CookieSessionManager !== 'undefined' ? 'Available' : 'Not Available'}<br>
                    authenticateUser: ${typeof window.authenticateUser !== 'undefined' ? 'Available' : 'Not Available'}<br>
                    Navigation Handler: ${typeof window.updateNavigationForUser !== 'undefined' ? 'Available' : 'Not Available'}<br>
                    Shared Users: ${window.sharedUsers ? window.sharedUsers.length : 'N/A'} users
                `;
                
            } catch (error) {
                sessionStatus.textContent = `‚ùå Error: ${error.message}`;
                debugInfo.textContent = `Error: ${error.message}`;
            }
        }
        
        function testBookingPopulation() {
            const bookingStatus = document.getElementById('bookingStatus');
            
            if (typeof window.CookieSessionManager === 'undefined') {
                bookingStatus.innerHTML = '<div class="error-indicator">CookieSessionManager not available</div>';
                return;
            }
            
            const currentUser = window.CookieSessionManager.getCurrentUser();
            const nameField = document.getElementById('clientName');
            const emailField = document.getElementById('email');
            const phoneField = document.getElementById('phone');
            
            if (currentUser) {
                // Simulate booking page auto-population logic
                if (nameField && !nameField.value) {
                    nameField.value = currentUser.name || '';
                    nameField.style.backgroundColor = '#f0f8ff';
                }
                if (emailField && !emailField.value) {
                    emailField.value = currentUser.email || '';
                    emailField.style.backgroundColor = '#f0f8ff';
                }
                if (phoneField && !phoneField.value && currentUser.phone) {
                    phoneField.value = currentUser.phone;
                    phoneField.style.backgroundColor = '#f0f8ff';
                }
                
                bookingStatus.innerHTML = '<div class="success-indicator">‚úÖ Auto-population successful! Fields filled with user data.</div>';
            } else {
                // Clear fields when not logged in
                if (nameField) {
                    nameField.value = '';
                    nameField.style.backgroundColor = '';
                }
                if (emailField) {
                    emailField.value = '';
                    emailField.style.backgroundColor = '';
                }
                if (phoneField) {
                    phoneField.value = '';
                    phoneField.style.backgroundColor = '';
                }
                
                bookingStatus.innerHTML = '<div class="error-indicator">‚ùå Not logged in - fields cleared</div>';
            }
        }
        
        function simulateJoinNow() {
            const membershipStatus = document.getElementById('membershipStatus');
            
            if (typeof window.CookieSessionManager === 'undefined') {
                membershipStatus.innerHTML = '<div class="error-indicator">CookieSessionManager not available</div>';
                return;
            }
            
            const currentUser = window.CookieSessionManager.getCurrentUser();
            const membershipBtn = document.querySelector('.membership-btn');
            
            if (currentUser && membershipBtn) {
                membershipBtn.textContent = `Join Now - ${currentUser.name}`;
                membershipBtn.style.background = '#27ae60';
                membershipStatus.innerHTML = '<div class="success-indicator">‚úÖ Membership button personalized! Login should persist through membership flow.</div>';
            } else if (membershipBtn) {
                membershipBtn.textContent = 'Join Now';
                membershipBtn.style.background = '#3A7D99';
                membershipStatus.innerHTML = '<div class="error-indicator">‚ùå Not logged in - button shows generic text</div>';
            }
        }
        
        function refreshAll() {
            updateStatus();
            testBookingPopulation();
            simulateJoinNow();
        }
        
        function testLogin() {
            if (window.authenticateUser) {
                // Try multiple potential working credentials
                const testCredentials = [
                    {email: 'test@test.com', password: 'test123'},
                    {email: 'test@example.com', password: 'test123'},
                    {email: 'john.doe@email.com', password: 'user123'},
                    {email: 'd@d', password: 'd'},
                    {email: 'a@a', password: 'a'}
                ];
                
                let success = false;
                for (const cred of testCredentials) {
                    const user = window.authenticateUser(cred.email, cred.password);
                    if (user && window.CookieSessionManager) {
                        window.CookieSessionManager.login(user);
                        setTimeout(refreshAll, 200);
                        console.log(`‚úÖ Logged in successfully with: ${cred.email} / ${cred.password}`);
                        success = true;
                        break;
                    }
                }
                
                if (!success) {
                    alert('Login failed with all test credentials - check console for details');
                    console.log('Available users:', window.sharedUsers);
                }
            } else {
                alert('Authentication system not available');
            }
        }
        
        function testLogout() {
            if (window.CookieSessionManager) {
                window.CookieSessionManager.logout();
                setTimeout(refreshAll, 200);
            }
        }
        
        // Initialize
        setTimeout(() => {
            refreshAll();
            setInterval(updateStatus, 15000); // Refresh status every 15 seconds
        }, 1000);
        
        // Listen for auth events
        window.addEventListener('userAuthChanged', () => {
            setTimeout(refreshAll, 100);
        });
        
        window.addEventListener('userLoggedOut', () => {
            setTimeout(refreshAll, 100);
        });
    </script>
</body>
</html>