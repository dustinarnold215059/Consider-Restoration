<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Book Massage Appointment Online - Consider Restoration | Livonia, MI</title>
    <meta name="description" content="Book your massage appointment online with Christopher Rembisz, LMT in Livonia, MI. Available services include Swedish, deep tissue, prenatal massage, and applied neurology consultations.">
    <meta name="keywords" content="book massage appointment, online booking, massage therapy Livonia, Swedish massage, deep tissue massage, prenatal massage">
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="./manifest.json">
    <!-- <script src="js/logger.js"></script> -->
    <script src="js/portal-session-manager.js"></script>
    <!-- DISABLED old session restoration on booking page -->
    <!-- <script src="js/secure-session.js"></script> -->
    <!-- <script src="js/advanced-cache.js"></script> DISABLED - not deployed to Vercel -->
    <!-- <script src="js/code-quality-monitor.js"></script> DISABLED - not deployed to Vercel -->
    <script src="js/accessibility-enhancer.js"></script>
    <style>
        /* Time blocking styles */
        option.blocked-time {
            color: #999 !important;
            font-weight: bold !important;
            background-color: #f8f8f8 !important;
            font-style: italic !important;
        }
        option.available-time {
            color: #333 !important;
        }
        /* Additional styling for disabled options */
        option:disabled {
            color: #999 !important;
            background-color: #f0f0f0 !important;
            font-style: italic !important;
        }
    </style>
    <meta name="theme-color" content="#3A7D99">
    <style>
        /* Modal Styles - Emergency approach that works */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.8);
            z-index: 99999;
            display: none;
        }
        
        .modal.show {
            display: block;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .modal-header {
            background: #3A7D99;
            color: white;
            padding: 10px 15px;
            margin: -20px -20px 15px -20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 18px;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-modal:hover {
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        
        .modal-body {
            /* No additional padding needed - handled by modal-content */
        }
        
        .booking-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .booking-preview h4 {
            margin: 0 0 10px 0;
            color: #3A7D99;
        }
        
        .booking-detail {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .booking-detail:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 18px;
            color: #28a745;
        }
        
        .auth-tabs {
            display: flex;
            margin: 20px 0 15px 0;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            color: #3A7D99;
            border-bottom-color: #3A7D99;
            font-weight: bold;
        }
        
        .tab-btn:hover {
            background: #f8f9fa;
        }
        
        .auth-form {
            margin-top: 20px;
        }
        
        .auth-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            transition: all 0.3s;
        }
        
        .auth-btn:hover {
            background: linear-gradient(135deg, #218838, #1cc88a);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .demo-accounts {
            margin-top: 25px;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
        }
        
        .demo-accounts h4 {
            margin: 0 0 15px 0;
            color: #856404;
        }
        
        .demo-account {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 8px;
            background: white;
            border-radius: 5px;
        }
        
        .demo-account button {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .demo-account button:hover {
            background: #e0a800;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                max-width: none;
                max-height: 90vh;
                border-radius: 5px;
                padding: 15px;
            }
            
            .modal-header {
                margin: -15px -15px 12px -15px;
                padding: 8px 12px;
            }
            
            .modal-header h2 {
                font-size: 16px;
            }
            
            .booking-preview {
                margin: 10px 0;
                padding: 8px;
            }
            
            .booking-detail {
                font-size: 13px;
                padding: 2px 0;
            }
            
            .auth-tabs {
                margin: 12px 0 8px 0;
            }
            
            .tab-btn {
                padding: 6px 12px;
                font-size: 13px;
            }
            
            .auth-btn {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .demo-accounts {
                margin-top: 12px;
                padding: 8px;
            }
            
            .demo-account {
                flex-direction: column;
                gap: 6px;
                text-align: center;
                padding: 5px;
                margin: 6px 0;
            }
            
            .demo-account button {
                padding: 4px 8px;
                font-size: 11px;
            }
        }
        
        @media (max-height: 600px) {
            .modal-content {
                max-height: 95vh;
                padding: 12px;
            }
            
            .modal-header {
                margin: -12px -12px 10px -12px;
            }
        }
        
        /* Modern Beautiful Calendar */
        #calendar {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            padding: 24px;
            margin: 20px 0;
            display: flex;
            flex-direction: column;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            order: 0; /* Position first */
        }
        
        .nav-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: none;
            background: #f8fafc;
            color: #64748b;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .nav-btn:hover {
            background: #3A7D99;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(58, 125, 153, 0.3);
        }
        
        .month-year {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
            letter-spacing: -0.5px;
        }
        
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin: 0 0 16px 0;
            order: 1; /* Position after header but before grid */
        }
        
        .weekday {
            text-align: center;
            font-weight: 700;
            color: #475569;
            font-size: 14px;
            padding: 12px 0;
            text-transform: uppercase;
            letter-spacing: 0.75px;
            background: #f1f5f9;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            order: 2; /* Position after weekdays */
        }
        
        .calendar-day {
            aspect-ratio: 1;
            min-height: 56px;
            background: #f8fafc;
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            font-weight: 500;
        }
        
        .calendar-day:hover:not(.past):not(.other-month):not(.fully-booked) {
            border-color: #3A7D99;
            background: rgba(58, 125, 153, 0.05);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(58, 125, 153, 0.15);
        }
        
        .calendar-day.other-month {
            background: transparent;
            color: #cbd5e1;
            cursor: default;
        }
        
        .calendar-day.past {
            background: #f1f5f9;
            color: #94a3b8;
            cursor: default;
        }
        
        .calendar-day.today {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }
        
        .calendar-day.available {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-weight: 600;
        }
        
        .calendar-day.available:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }
        
        .calendar-day.fully-booked {
            background: #fee2e2;
            color: #dc2626;
            border-color: #fecaca;
            cursor: default;
            position: relative;
        }
        
        .calendar-day.fully-booked::after {
            content: '‚úï';
            position: absolute;
            top: 2px;
            right: 6px;
            font-size: 10px;
            opacity: 0.6;
        }
        
        .calendar-day.blocked {
            background: #ffeaa7;
            color: #d63031;
            cursor: not-allowed;
            border-color: #fdcb6e;
            font-weight: bold;
        }
        
        .calendar-day.selected {
            background: linear-gradient(135deg, #3A7D99, #2c5f75);
            color: white;
            font-weight: 700;
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(58, 125, 153, 0.5);
        }
        
        .day-number {
            font-size: 16px;
            line-height: 1;
        }
        
        .availability-indicator {
            font-size: 9px;
            font-weight: 600;
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 8px;
            white-space: nowrap;
        }
        
        .calendar-day.available .availability-indicator {
            background: rgba(255,255,255,0.25);
            color: rgba(255,255,255,0.9);
        }
        
        .calendar-day.fully-booked .availability-indicator {
            background: rgba(220, 38, 38, 0.1);
            color: #dc2626;
        }
        
        /* Subtle pulse animation for today */
        .calendar-day.today {
            animation: todayPulse 2s ease-in-out infinite;
        }
        
        @keyframes todayPulse {
            0%, 100% { box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4); }
            50% { box-shadow: 0 6px 20px rgba(251, 191, 36, 0.6); }
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            #calendar {
                padding: 16px;
            }
            
            .calendar-day {
                min-height: 48px;
                border-radius: 10px;
            }
            
            .day-number {
                font-size: 14px;
            }
            
            .availability-indicator {
                font-size: 8px;
                padding: 1px 4px;
            }
            
            .month-year {
                font-size: 22px;
            }
            
            .nav-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
        }
    </style>
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- Browser compatibility polyfills (load first) -->
    <script src="js/browser-compatibility.js"></script>
    <!-- <script src="js/production-logger.js"></script> -->
    
    <!-- Utility scripts -->
    <script src="js/site-config.js"></script>
    <script src="js/environment-config.js"></script>
    <script src="js/toast-notifications.js"></script>
    
    <script src="js/enhanced-error-handler.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
    <!-- DISABLED session/auth scripts on booking page -->
    <!-- <script src="js/secure-tokens.js" defer></script> -->
    <!-- <script src="js/auth-security.js?v=20250813b" defer></script> -->
    <!-- <script src="js/secure-init.js" defer></script> -->
    <script src="js/api-client.js" defer></script>
    <script src="js/data-persistence-fixed.js" defer></script>
    <script src="js/shared-data.js" defer></script>
    <script src="js/performance-optimizer.js" defer></script>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-container">
                <h1 class="logo">Consider Restoration</h1>
                <ul class="nav-menu">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="services.html">Services</a></li>
                    <li><a href="membership.html">Membership</a></li>
                    <li><a href="booking.html" class="active">Book Appointment</a></li>
                    <li><a href="reviews.html">Reviews</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><a href="user-portal.html" id="accountNavLink">Login</a></li>
                    <li id="adminNavLink" style="display: none !important;"><a href="admin.html">Admin</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <main>
        <section class="booking page-section">
            <div class="container">
                <h1>Book Your Session</h1>
                <div class="booking-hours-info">
                    <h4>Business Hours:</h4>
                    <ul>
                        <li><strong>Monday:</strong> 10:00 AM - 4:00 PM</li>
                        <li><strong>Tuesday:</strong> By appointment only</li>
                        <li><strong>Wednesday:</strong> 9:45 AM - 5:30 PM</li>
                        <li><strong>Thursday:</strong> 12:00 PM - 7:00 PM</li>
                        <li><strong>Friday:</strong> 10:00 AM - 6:00 PM</li>
                        <li><strong>Saturday/Sunday:</strong> Closed</li>
                    </ul>
                </div>
                <div class="booking-form-container">
                    <form id="bookingForm" class="booking-form">
                        <div class="form-group">
                            <label for="clientName">Full Name:</label>
                            <input type="text" id="clientName" name="clientName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="phone">Phone Number:</label>
                            <input type="tel" id="phone" name="phone" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="service">Service:</label>
                            <select id="service" name="service" required>
                                <option value="">Select a service</option>
                                <option value="mindful-start" data-price="70">Mindful Start - Starting at $70</option>
                                <option value="integrated-massage" data-price="100">Integrated Massage - $100+</option>
                                <option value="thai-stretch" data-price="120">Thai-Stretch Fusion - $120+</option>
                                <option value="applied-neurology" data-price="150">Applied Neurology Consultation - $150+</option>
                                <option value="prenatal" data-price="90">Prenatal Massage - $90</option>
                                <option value="neurology-training" data-price="330">Applied Neurology Training - Up to $330</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="date">Preferred Date:</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="time">Preferred Time:</label>
                            <select id="time" name="time" required>
                                <option value="">Select a time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="notes">Special Requests/Notes:</label>
                            <textarea id="notes" name="notes" rows="3"></textarea>
                        </div>
                        
                        <div class="booking-summary">
                            <div class="price-display">
                                <strong>Total: $<span id="totalPrice">0</span></strong>
                            </div>
                        </div>
                        
                        <button type="submit" class="book-button" onclick="handleBookingSubmit(event)">Book & Pay Now</button>
                    </form>
                    
                    <div class="availability-calendar">
                        <h3>Available Times</h3>
                        <div id="calendar"></div>
                    </div>
                </div>
                
                <!-- Login Modal -->
                <div id="loginModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Login Required</h2>
                            <span class="close-modal" onclick="closeLoginModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <p><strong>Login to complete booking</strong></p>
                            
                            <div class="booking-preview" id="bookingPreview">
                                <!-- Booking details will be shown here -->
                            </div>
                            
                            <div class="auth-tabs">
                                <button class="tab-btn active" onclick="showLoginTab()">Login</button>
                                <button class="tab-btn" onclick="showRegisterTab()">Register</button>
                            </div>
                            
                            <!-- Login Form -->
                            <form id="loginForm" class="auth-form" style="display: block;">
                                <div class="form-group">
                                    <label for="loginEmail">Email:</label>
                                    <input type="email" id="loginEmail" name="email" required>
                                </div>
                                <div class="form-group">
                                    <label for="loginPassword">Password:</label>
                                    <input type="password" id="loginPassword" name="password" required>
                                </div>
                                <button type="submit" class="auth-btn">Login & Complete Booking</button>
                            </form>
                            
                            <!-- Register Form -->
                            <form id="registerForm" class="auth-form" style="display: none;">
                                <div class="form-group">
                                    <label for="registerName">Full Name:</label>
                                    <input type="text" id="registerName" name="name" required>
                                </div>
                                <div class="form-group">
                                    <label for="registerEmail">Email:</label>
                                    <input type="email" id="registerEmail" name="email" required>
                                </div>
                                <div class="form-group">
                                    <label for="registerPhone">Phone:</label>
                                    <input type="tel" id="registerPhone" name="phone" required>
                                </div>
                                <div class="form-group">
                                    <label for="registerPassword">Password:</label>
                                    <input type="password" id="registerPassword" name="password" required>
                                </div>
                                <div class="form-group">
                                    <label for="confirmPassword">Confirm Password:</label>
                                    <input type="password" id="confirmPassword" name="confirmPassword" required>
                                </div>
                                <button type="submit" class="auth-btn">Register & Complete Booking</button>
                            </form>
                            
                            <div class="security-notice">
                                <h4>üîí Secure Registration</h4>
                                <p>Create a new account to book your appointment. All passwords are encrypted with bcrypt for maximum security.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="booking-info">
                    <h2>Before Your Appointment</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <h4>What to Bring</h4>
                            <ul>
                                <li>Comfortable clothing</li>
                                <li>List of current medications</li>
                                <li>Insurance card (if applicable)</li>
                            </ul>
                        </div>
                        <div class="info-item">
                            <h4>Arrival Time</h4>
                            <p>Please arrive 10-15 minutes early for intake forms and consultation.</p>
                        </div>
                        <div class="info-item">
                            <h4>Cancellation Policy</h4>
                            <p>24-hour notice required for cancellations to avoid fees.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 Consider Restoration - Christopher Rembisz, LMT. All rights reserved.</p>
        </div>
    </footer>

    <!-- Original script temporarily disabled -->
    <!-- <script src="js/script.js"></script> -->
    
    <!-- Clean, working version - TEMPORARILY DISABLED FOR TESTING -->
    <!-- <script src="js/booking-simple.js"></script> -->
    
    <script>
        // Prevent duplicate submissions
        let isSubmitting = false;
        
        // Direct inline handler as backup
        function handleBookingSubmit(event) {
            console.log('üöÄ Direct handler called');
            console.log('Event received:', event);
            event.preventDefault();
            
            // Prevent duplicate submissions
            if (isSubmitting) {
                console.log('‚ö†Ô∏è Already submitting, ignoring duplicate');
                return;
            }
            isSubmitting = true;
            
            try {
                // Get form values
                const clientName = document.getElementById('clientName').value.trim();
                const email = document.getElementById('email').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const service = document.getElementById('service').value;
                const date = document.getElementById('date').value;
                const time = document.getElementById('time').value;
                const notes = document.getElementById('notes').value;
                
                console.log('Form values:', { clientName, email, phone, service, date, time });
                
                // Basic validation
                if (!clientName || !email || !phone || !service || !date || !time) {
                    Toast.error('Please fill in all required fields.', 'Form Incomplete');
                    return;
                }
                
                // Validate that the selected date is not blocked
                if (date && isDateBlocked(date)) {
                    Toast.error('Sorry, the selected date is not available for appointments. Please choose a different date.', 'Date Not Available');
                    isSubmitting = false;
                    return;
                }
                
                // Store booking data
                window.pendingBookingData = {
                    clientName: clientName,
                    email: email,
                    phone: phone,
                    service: service,
                    date: date,
                    time: time,
                    price: document.getElementById('totalPrice').textContent || '0',
                    notes: notes
                };
                
                console.log('Booking data stored:', window.pendingBookingData);
                
                // Debug: Check if shared data is available
                console.log('üîç Checking shared data availability...');
                console.log('window.sharedAppointments:', window.sharedAppointments);
                console.log('window.addAppointment:', typeof window.addAppointment);
                console.log('window.sharedUsers:', window.sharedUsers);
                console.log('window.addUser:', typeof window.addUser);
                
                // Check if user is already logged in
                console.log('üîç About to check shouldSkipLoginModal()...');
                const skipLogin = shouldSkipLoginModal();
                console.log('üîç shouldSkipLoginModal() returned:', skipLogin);
                
                if (skipLogin) {
                    console.log('‚úÖ User is logged in, payment modal should have been shown');
                    return;
                }
                
                console.log('User not logged in, showing login modal...');
                
                // Always use the emergency modal approach
                console.log('Using emergency modal directly...');
                showModalDirect();
                
            } catch (error) {
                console.error('Booking submission error:', error);
                Toast.error('An error occurred during booking. Please try again or contact support.', 'Booking Error');
            } finally {
                // Reset submission flag
                setTimeout(() => {
                    isSubmitting = false;
                    console.log('üîì Submission flag reset');
                }, 2000);
            }
        }
        
        // Direct modal show function - Emergency approach that always works
        function showModalDirect() {
            console.log('üö® showModalDirect() called - starting emergency modal injection...');
            
            // First, remove any existing emergency modals
            const existingModal = document.getElementById('emergencyLoginModal');
            if (existingModal) {
                existingModal.remove();
                console.log('üóëÔ∏è Removed existing emergency modal');
            }
            
            // Show booking preview data
            const serviceDisplay = getServiceDisplayName(window.pendingBookingData?.service || 'Selected Service');
            const dateDisplay = window.pendingBookingData?.date || 'Selected Date';
            const timeDisplay = window.pendingBookingData?.time || 'Selected Time';
            const priceDisplay = window.pendingBookingData?.price || '0';
            
            // Inject emergency modal directly into body
            const emergencyModal = document.createElement('div');
            emergencyModal.id = 'emergencyLoginModal';
            emergencyModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0,0,0,0.9);
                z-index: 999999;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 10px;
                box-sizing: border-box;
            `;
            
            emergencyModal.innerHTML = `
                <div style="
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    max-width: 400px;
                    width: 100%;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
                ">
                    <div style="
                        background: #3A7D99;
                        color: white;
                        padding: 15px;
                        margin: -20px -20px 20px -20px;
                        border-radius: 8px 8px 0 0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <h3 style="margin: 0; font-size: 18px;">Login Required</h3>
                        <button onclick="closeEmergencyModal()" style="
                            background: none;
                            border: none;
                            color: white;
                            font-size: 24px;
                            cursor: pointer;
                            padding: 0;
                            width: 30px;
                            height: 30px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">&times;</button>
                    </div>
                    
                    <p><strong>Please login to complete your booking</strong></p>
                    
                    <div style="
                        background: #f8f9fa;
                        border: 1px solid #dee2e6;
                        border-radius: 8px;
                        padding: 15px;
                        margin: 15px 0;
                    ">
                        <h4 style="margin: 0 0 10px 0; color: #3A7D99;">Your Booking Details:</h4>
                        <div style="display: flex; justify-content: space-between; margin: 5px 0; padding: 5px 0; border-bottom: 1px solid #eee;">
                            <span>Service:</span>
                            <span>${serviceDisplay}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 5px 0; padding: 5px 0; border-bottom: 1px solid #eee;">
                            <span>Date:</span>
                            <span>${dateDisplay}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 5px 0; padding: 5px 0; border-bottom: 1px solid #eee;">
                            <span>Time:</span>
                            <span>${timeDisplay}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 5px 0; padding: 5px 0; font-weight: bold; color: #28a745;">
                            <span>Total:</span>
                            <span>$${priceDisplay}</span>
                        </div>
                    </div>
                    
                    <!-- Auth Tabs -->
                    <div style="
                        display: flex;
                        margin: 20px 0 15px 0;
                        border-bottom: 2px solid #e9ecef;
                    ">
                        <button onclick="showEmergencyLoginTab()" id="emergencyLoginTab" style="
                            background: none;
                            border: none;
                            padding: 12px 24px;
                            font-size: 16px;
                            cursor: pointer;
                            border-bottom: 3px solid #3A7D99;
                            color: #3A7D99;
                            font-weight: bold;
                            flex: 1;
                        ">Existing Account</button>
                        <button onclick="showEmergencyRegisterTab()" id="emergencyRegisterTab" style="
                            background: none;
                            border: none;
                            padding: 12px 24px;
                            font-size: 16px;
                            cursor: pointer;
                            border-bottom: 3px solid #3A7D99;
                            color: #3A7D99;
                            font-weight: bold;
                            flex: 1;
                        ">‚ú® Create New Account</button>
                    </div>
                    
                    <!-- Login Form -->
                    <form id="emergencyLoginForm" onsubmit="handleEmergencyLogin(event)" style="display: block;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email:</label>
                            <input type="email" id="emergencyEmail" required style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 5px;
                                font-size: 16px;
                                box-sizing: border-box;
                            ">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Password:</label>
                            <input type="password" id="emergencyPassword" required style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 5px;
                                font-size: 16px;
                                box-sizing: border-box;
                            ">
                        </div>
                        
                        <button type="submit" style="
                            background: #28a745;
                            color: white;
                            border: none;
                            padding: 15px 20px;
                            border-radius: 5px;
                            cursor: pointer;
                            width: 100%;
                            font-size: 16px;
                            margin-top: 10px;
                        ">‚úÖ Login & Complete Booking</button>
                    </form>
                    
                    <!-- Registration Form -->
                    <form id="emergencyRegisterForm" onsubmit="handleEmergencyRegister(event)" style="display: none;">
                        <div style="
                            background: #d4edda;
                            border: 1px solid #c3e6cb;
                            border-radius: 5px;
                            padding: 10px;
                            margin-bottom: 15px;
                            color: #155724;
                            text-align: center;
                        ">
                            <strong>‚ú® New Customer?</strong><br>
                            Create an account to save your info for faster future bookings!
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Full Name:</label>
                            <input type="text" id="emergencyRegisterName" required style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 5px;
                                font-size: 16px;
                                box-sizing: border-box;
                            ">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email:</label>
                            <input type="email" id="emergencyRegisterEmail" required style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 5px;
                                font-size: 16px;
                                box-sizing: border-box;
                            ">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Phone:</label>
                            <input type="tel" id="emergencyRegisterPhone" required style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 5px;
                                font-size: 16px;
                                box-sizing: border-box;
                            ">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Create Password:</label>
                            <input type="password" id="emergencyRegisterPassword" required minlength="6" style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 5px;
                                font-size: 16px;
                                box-sizing: border-box;
                            ">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Confirm Password:</label>
                            <input type="password" id="emergencyConfirmPassword" required minlength="6" style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 5px;
                                font-size: 16px;
                                box-sizing: border-box;
                            ">
                        </div>
                        
                        <button type="submit" style="
                            background: linear-gradient(135deg, #007bff, #0056b3);
                            color: white;
                            border: none;
                            padding: 15px 20px;
                            border-radius: 5px;
                            cursor: pointer;
                            width: 100%;
                            font-size: 16px;
                            margin-top: 10px;
                        ">üéâ Create Account & Complete Booking</button>
                        
                        <p style="
                            font-size: 12px;
                            color: #666;
                            text-align: center;
                            margin-top: 10px;
                            line-height: 1.4;
                        ">By creating an account, you agree to our terms of service. Your information is kept secure and private.</p>
                    </form>
                    
                    <div style="
                        background: #fff3cd;
                        border: 1px solid #ffeaa7;
                        border-radius: 8px;
                        padding: 15px;
                        margin-top: 20px;
                        text-align: center;
                    ">
                        <h4 style="margin: 0 0 10px 0; color: #2d5aa0;">üîí Production System:</h4>
                        <p style="margin: 5px 0; font-size: 13px; color: #2d5aa0;">
                            <strong>Secure Access:</strong><br>
                            All accounts use encrypted passwords.<br>
                            Create an account or contact support for access.
                        </p>
                        <button onclick="fillEmergencyDemo()" style="
                            background: #ffc107;
                            color: #212529;
                            border: none;
                            padding: 6px 10px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 11px;
                            margin: 5px;
                        ">Try Demo Login</button>
                        <button onclick="showEmergencyRegisterTab()" style="
                            background: #28a745;
                            color: white;
                            border: none;
                            padding: 6px 10px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 11px;
                            margin: 5px;
                        ">Create Real Account</button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <button onclick="logoutAndContinue()" style="
                            background: #dc3545;
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 3px;
                            cursor: pointer;
                            font-size: 12px;
                        ">Logout Current User</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(emergencyModal);
            document.body.style.overflow = 'hidden';
            
            console.log('‚úÖ Emergency modal injected and should be visible');
            console.log('üìä Modal element:', emergencyModal);
            console.log('üìä Modal display style:', window.getComputedStyle(emergencyModal).display);
            console.log('üìä Modal position:', window.getComputedStyle(emergencyModal).position);
            
            // Final fallback - alert if modal might not be visible
            setTimeout(() => {
                const modalRect = emergencyModal.getBoundingClientRect();
                console.log('üìè Modal position:', modalRect);
                if (modalRect.width === 0 || modalRect.height === 0) {
                    alert('üö® EMERGENCY: Modal created but not visible! Check browser zoom/viewport. Press F5 to refresh and try again.');
                }
            }, 100);
        }
        
        // Helper function for saving appointments
        function saveAppointment(appointmentData) {
            console.log('üíæ Attempting to save appointment:', appointmentData);
            
            // Validate appointment data
            if (!appointmentData.date || !appointmentData.time || !appointmentData.clientName) {
                console.error('‚ùå Invalid appointment data - missing required fields:', appointmentData);
                return null;
            }
            
            let savedAppointment;
            if (typeof window.addAppointment === 'function') {
                console.log('üîß Using window.addAppointment function');
                savedAppointment = window.addAppointment(appointmentData);
                console.log('‚úÖ Appointment saved via addAppointment:', savedAppointment);
                
                // Double-check it was actually saved
                if (window.getAppointments) {
                    const allAppointments = window.getAppointments();
                    console.log('üìä Total appointments after save:', allAppointments.length);
                    const justSaved = allAppointments.find(apt => apt.id === (savedAppointment && savedAppointment.id));
                    if (justSaved) {
                        console.log('‚úÖ Verification: Appointment found in shared data:', justSaved);
                        // Refresh the calendar to show updated availability
                        console.log('üîÑ Refreshing calendar after appointment save...');
                        generateMonthlyCalendar();
                    } else {
                        console.error('‚ùå Verification failed: Appointment not found in shared data!');
                    }
                }
            } else {
                console.log('‚ö†Ô∏è window.addAppointment not available, using fallback...');
                // Fallback: save directly to shared array
                if (!window.sharedAppointments) {
                    window.sharedAppointments = [];
                    console.log('üìù Created new sharedAppointments array');
                }
                const newId = Math.max(...(window.sharedAppointments.map(apt => apt.id) || [0]), 0) + 1;
                savedAppointment = { 
                    id: newId, 
                    ...appointmentData,
                    createdAt: new Date().toISOString()
                };
                window.sharedAppointments.push(savedAppointment);
                console.log('‚úÖ Appointment saved via fallback:', savedAppointment);
                console.log('üìä Total appointments in array:', window.sharedAppointments.length);
                
                // Refresh the calendar to show updated availability
                console.log('üîÑ Refreshing calendar after fallback appointment save...');
                generateMonthlyCalendar();
                
                // Save to localStorage
                try {
                    localStorage.setItem('massageAppointments', JSON.stringify(window.sharedAppointments));
                    console.log('üíæ Appointments saved to localStorage');
                    
                    // Verify localStorage save
                    const savedData = localStorage.getItem('massageAppointments');
                    const parsedData = JSON.parse(savedData || '[]');
                    console.log('üîç Verification: localStorage has', parsedData.length, 'appointments');
                    
                    // Trigger email automation for the new appointment
                    if (window.EmailAutomation && window.EmailAutomation.initialized) {
                        console.log('üìß Triggering appointment confirmation email');
                        window.dispatchEvent(new CustomEvent('appointmentBooked', {
                            detail: {
                                ...savedAppointment,
                                clientName: savedAppointment.name,
                                clientEmail: savedAppointment.email,
                                status: 'confirmed'
                            }
                        }));
                    } else {
                        console.log('üìß Email automation not available, scheduling for later');
                        setTimeout(() => {
                            if (window.EmailAutomation && window.EmailAutomation.initialized) {
                                window.dispatchEvent(new CustomEvent('appointmentBooked', {
                                    detail: {
                                        ...savedAppointment,
                                        clientName: savedAppointment.name,
                                        clientEmail: savedAppointment.email,
                                        status: 'confirmed'
                                    }
                                }));
                            }
                        }, 2000);
                    }
                } catch (e) {
                    console.error('‚ùå Failed to save to localStorage:', e);
                }
                
                // Trigger event to notify admin panel
                try {
                    window.dispatchEvent(new CustomEvent('appointmentAdded', { detail: savedAppointment }));
                    console.log('üì° Event dispatched: appointmentAdded');
                } catch (e) {
                    console.error('‚ùå Failed to dispatch event:', e);
                }
                
                // Update available times to reflect new booking
                console.log('üîÑ Refreshing available times after new appointment');
                updateAvailableTimes();
            }
            return savedAppointment;
        }
        
        // Helper function for saving users
        function saveUser(userData) {
            console.log('üë§ Attempting to save user:', userData);
            
            let savedUser;
            if (typeof window.addUser === 'function') {
                savedUser = window.addUser(userData);
                console.log('‚úÖ User saved via addUser:', savedUser);
            } else {
                console.log('‚ö†Ô∏è window.addUser not available, using fallback...');
                // Fallback: save directly to shared array
                if (!window.sharedUsers) {
                    window.sharedUsers = [];
                    console.log('üìù Created new sharedUsers array');
                }
                const newId = Math.max(...(window.sharedUsers.map(user => user.id) || [0]), 0) + 1;
                savedUser = { 
                    id: newId, 
                    ...userData 
                };
                window.sharedUsers.push(savedUser);
                console.log('‚úÖ User saved via fallback:', savedUser);
                
                // Save to localStorage
                try {
                    localStorage.setItem('massageUsers', JSON.stringify(window.sharedUsers));
                    console.log('üíæ Users saved to localStorage');
                    
                    // Trigger welcome email for new user
                    if (window.EmailAutomation && window.EmailAutomation.initialized) {
                        console.log('üìß Triggering welcome email for new user');
                        window.dispatchEvent(new CustomEvent('userRegistered', {
                            detail: {
                                id: savedUser.id,
                                name: savedUser.name,
                                email: savedUser.email,
                                emailVerified: true
                            }
                        }));
                    } else {
                        console.log('üìß Email automation not ready, scheduling welcome email');
                        setTimeout(() => {
                            if (window.EmailAutomation && window.EmailAutomation.initialized) {
                                window.dispatchEvent(new CustomEvent('userRegistered', {
                                    detail: {
                                        id: savedUser.id,
                                        name: savedUser.name,
                                        email: savedUser.email,
                                        emailVerified: true
                                    }
                                }));
                            }
                        }, 2000);
                    }
                } catch (e) {
                    console.error('Failed to save to localStorage:', e);
                }
            }
            return savedUser;
        }
        
        // Helper function
        function getServiceDisplayName(serviceValue) {
            const serviceSelect = document.getElementById('service');
            if (serviceSelect) {
                const option = serviceSelect.querySelector(`option[value="${serviceValue}"]`);
                if (option) {
                    return option.textContent.split(' - ')[0];
                }
            }
            return serviceValue || 'Selected Service';
        }
        
        // Close modal functions
        function closeLoginModal() {
            console.log('Closing modal...');
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = '';
            }
        }
        
        function showLoginTab() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => tab.classList.remove('active'));
            tabs[0].classList.add('active');
        }
        
        function showRegisterTab() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => tab.classList.remove('active'));
            tabs[1].classList.add('active');
        }
        
        // fillDemoLogin function removed for security - no hardcoded credentials
        
        // Navigation and session management functions
        function updateNavigationForLoggedInUser(user) {
            const accountNavLink = document.getElementById('accountNavLink');
            console.log('üîç Looking for navigation element:', accountNavLink);
            
            if (accountNavLink) {
                // The ID is directly on the <a> tag, so update it directly
                const firstName = user.name.split(' ')[0];
                accountNavLink.textContent = `Welcome, ${firstName}`;
                accountNavLink.href = 'user-portal.html';
                console.log('‚úÖ Navigation text updated to:', accountNavLink.textContent);
            } else {
                console.log('‚ùå accountNavLink element not found');
            }
            console.log('Navigation update completed for:', user.name);
        }
        
        function checkUserSession() {
            console.log('üìÖ Checking user session for booking auto-population...');
            
            // Use cookie session manager instead of localStorage
            let user = null;
            if (window.CookieSessionManager) {
                user = window.CookieSessionManager.getCurrentUser();
                console.log('üìÖ CookieSessionManager result:', user ? `${user.name} (${user.email})` : 'No user');
            } else {
                console.log('üìÖ CookieSessionManager not available');
            }
            
            const nameField = document.getElementById('clientName');
            const emailField = document.getElementById('email');
            const phoneField = document.getElementById('phone');
            
            console.log('üìÖ Form fields found:', {
                nameField: !!nameField,
                emailField: !!emailField, 
                phoneField: !!phoneField
            });
            
            if (user) {
                console.log('‚úÖ User session found, auto-populating fields for:', user.name);
                updateNavigationForLoggedInUser(user);
                
                // Auto-fill user info if user is logged in
                if (nameField && !nameField.value) {
                    nameField.value = user.name || '';
                    nameField.style.backgroundColor = '#f0f8ff'; // Light blue to show pre-filled
                    console.log('üìÖ Populated name field:', user.name);
                }
                if (emailField && !emailField.value) {
                    emailField.value = user.email || '';
                    emailField.style.backgroundColor = '#f0f8ff';
                    console.log('üìÖ Populated email field:', user.email);
                }
                if (phoneField && !phoneField.value && user.phone) {
                    phoneField.value = user.phone;
                    phoneField.style.backgroundColor = '#f0f8ff';
                    console.log('üìÖ Populated phone field:', user.phone);
                }
                
                return user;
            } else {
                console.log('‚ùå No user session found, clearing fields');
                
                // Clear fields and reset styling when logged out
                if (nameField && nameField.style.backgroundColor === 'rgb(240, 248, 255)') {
                    nameField.value = '';
                    nameField.style.backgroundColor = '';
                }
                if (emailField && emailField.style.backgroundColor === 'rgb(240, 248, 255)') {
                    emailField.value = '';
                    emailField.style.backgroundColor = '';
                }
                if (phoneField && phoneField.style.backgroundColor === 'rgb(240, 248, 255)') {
                    phoneField.value = '';
                    phoneField.style.backgroundColor = '';
                }
                
                return null;
            }
        }
        
        function logoutUser() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('isLoggedIn');
            console.log('User logged out');
            
            // Reset navigation
            const accountNavLink = document.getElementById('accountNavLink');
            if (accountNavLink) {
                const link = accountNavLink.querySelector('a');
                if (link) {
                    link.textContent = 'Login';
                    link.href = 'user-portal.html';
                }
            }
            
            // Clear form fields
            const form = document.getElementById('bookingForm');
            if (form) form.reset();
        }
        
        // Check if user should skip login modal (already logged in)
        function shouldSkipLoginModal() {
            let currentUser = null;
            if (window.CookieSessionManager) {
                currentUser = window.CookieSessionManager.getCurrentUser();
            }
            console.log('üîç Checking login status:', { hasCurrentUser: !!currentUser });
            
            if (currentUser) {
                console.log('‚úÖ User already logged in, proceeding to payment...', currentUser);
                
                // Complete booking data and show payment modal instead of direct confirmation
                console.log('üìã Booking data:', window.pendingBookingData);
                
                // Debug: Check if booking data has required fields
                if (!window.pendingBookingData) {
                    console.error('‚ùå window.pendingBookingData is null/undefined!');
                    Toast.error('No booking data found. Please try submitting the form again.', 'Booking Data Missing');
                    return false;
                }
                
                if (!window.pendingBookingData.date || !window.pendingBookingData.time) {
                    console.error('‚ùå Missing date/time in booking data:', {
                        date: window.pendingBookingData.date,
                        time: window.pendingBookingData.time
                    });
                    Toast.error('Missing appointment date or time. Please select a date and time.', 'Incomplete Booking');
                    return false;
                }
                
                // Create the appointment data (but don't save it yet - save after payment)
                const newAppointment = {
                    userId: currentUser.id,
                    clientName: currentUser.name,
                    email: currentUser.email,
                    phone: currentUser.phone || window.pendingBookingData?.phone || '',
                    service: getServiceDisplayName(window.pendingBookingData?.service) || 'Selected Service',
                    date: window.pendingBookingData?.date || '',
                    time: window.pendingBookingData?.time || '',
                    price: parseInt(window.pendingBookingData?.price) || 0,
                    status: 'pending',
                    notes: window.pendingBookingData?.notes || '',
                    paymentStatus: 'pending',
                    paymentMethod: 'Stripe',
                    transactionId: null
                };
                
                console.log('üí≥ Proceeding to payment for logged-in user...');
                
                // Store the appointment data but DON'T save it yet - save after payment
                window.pendingAppointment = newAppointment;
                console.log('üìã Appointment stored as pending, will save after payment');
                
                // Show payment modal instead of directly confirming
                showBookingPaymentModal(newAppointment);
                
                return true; // Indicates login was skipped and booking is proceeding to payment
            }
            
            console.log('‚ùå User not logged in, will show login modal');
            return false;
        }
        
        // Time conversion helper functions
        function convertTo12Hour(time24) {
            if (!time24 || time24.includes('AM') || time24.includes('PM')) {
                console.log(`üîÑ convertTo12Hour: "${time24}" already in 12-hour format or invalid`);
                return time24; // Already in 12-hour format or invalid
            }
            
            const [hours, minutes] = time24.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            const result = `${hour12}:${minutes} ${ampm}`;
            console.log(`üîÑ convertTo12Hour: "${time24}" => "${result}"`);
            return result;
        }
        
        function convertTo24Hour(time12) {
            if (!time12 || (!time12.includes('AM') && !time12.includes('PM'))) {
                console.log(`üîÑ convertTo24Hour: "${time12}" already in 24-hour format or invalid`);
                return time12; // Already in 24-hour format or invalid
            }
            
            const [time, ampm] = time12.split(' ');
            const [hours, minutes] = time.split(':');
            let hour = parseInt(hours);
            
            if (ampm === 'AM' && hour === 12) hour = 0;
            else if (ampm === 'PM' && hour !== 12) hour += 12;
            
            const result = `${hour.toString().padStart(2, '0')}:${minutes}`;
            console.log(`üîÑ convertTo24Hour: "${time12}" => "${result}"`);
            return result;
        }

        // Initialize appointment data for time blocking
        function initializeAppointmentData() {
            console.log('üîÑ Initializing appointment data for time blocking...');
            
            // Load appointments from the data system
            if (window.getAppointments) {
                const allAppointments = window.getAppointments();
                window.sharedAppointments = allAppointments;
                console.log('‚úÖ Loaded', allAppointments.length, 'appointments for time blocking');
                console.log('üìã Appointment data:', allAppointments);
                
                // Refresh calendar when appointment data changes
                console.log('üîÑ Refreshing calendar after appointment data initialization...');
                generateMonthlyCalendar();
            } else {
                console.warn('‚ö†Ô∏è getAppointments function not available, time blocking may not work');
                window.sharedAppointments = [];
            }
        }

        // Time slot availability functions
        function getBookedTimesForDate(date) {
            console.log('üîç Checking booked times for date:', date);
            
            // Ensure appointment data is loaded
            if (!window.sharedAppointments && window.getAppointments) {
                console.log('üîÑ Appointment data not loaded, loading now...');
                initializeAppointmentData();
            }
            
            // Get appointments from shared data
            const appointments = window.sharedAppointments || [];
            console.log('üìÖ Total appointments in system:', appointments.length);
            console.log('üìÖ Sample appointments loaded:', appointments.length);
            
            // Normalize the input date to YYYY-MM-DD format
            const normalizedDate = normalizeDate(date);
            console.log('üîÑ Normalized target date:', normalizedDate);
            
            // Filter appointments for the specific date and confirmed/pending status
            const bookedTimes = appointments
                .filter(appointment => {
                    const aptNormalizedDate = normalizeDate(appointment.date);
                    const dateMatches = aptNormalizedDate === normalizedDate;
                    const statusMatches = (appointment.status === 'confirmed' || appointment.status === 'pending');
                    const matches = dateMatches && statusMatches;
                    
                    console.log('üìÖ Appointment check:', {
                        date: appointment.date,
                        matches: matches,
                        status: appointment.status
                    });
                    
                    if (matches) {
                        console.log('üìç Found booking for', normalizedDate, ':', appointment.time, appointment.service, '(original date:', appointment.date + ')');
                    }
                    return matches;
                })
                .map(appointment => appointment.time);
            
            console.log('üìÖ Booked times calculated:', { date, count: bookedTimes.length });
            return bookedTimes;
        }
        
        // Helper function to normalize dates to YYYY-MM-DD format
        function normalizeDate(dateStr) {
            if (!dateStr) return '';
            
            // If already in YYYY-MM-DD format, return as is
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            
            // Try to parse different formats
            let date;
            
            // Handle MM/DD/YYYY format
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                const [month, day, year] = dateStr.split('/');
                date = new Date(year, month - 1, day);
            }
            // Handle DD/MM/YYYY format
            else if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                // Ambiguous - assume MM/DD/YYYY for US format
                const [month, day, year] = dateStr.split('/');
                date = new Date(year, month - 1, day);
            }
            // Handle other formats by letting Date constructor parse
            else {
                date = new Date(dateStr);
            }
            
            // Convert to YYYY-MM-DD
            if (date && !isNaN(date.getTime())) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            console.warn('‚ö†Ô∏è Could not normalize date:', dateStr);
            return dateStr; // Return original if can't parse
        }
        
        function updateAvailableTimes() {
            const dateInput = document.getElementById('date');
            const timeSelect = document.getElementById('time');
            
            if (!timeSelect || !dateInput) {
                console.warn('‚ö†Ô∏è Missing time select or date input elements');
                return;
            }
            
            const selectedDate = dateInput.value;
            if (!selectedDate) {
                console.log('üîÑ No date selected, skipping time update');
                timeSelect.innerHTML = '<option value="">Select a date first</option>';
                return;
            }
            
            console.log('üîÑ Updating available times for:', selectedDate);
            
            // Clear existing options
            timeSelect.innerHTML = '<option value="">Loading times...</option>';
            
            // Force refresh appointment data
            initializeAppointmentData();
            
            // Available time slots (simplified for demo)
            const allTimes = ['10:00 AM', '11:00 AM', '12:00 PM', '1:00 PM', '2:00 PM', '3:00 PM'];
            
            // Get booked times for this date
            const bookedTimes = getBookedTimesForDate(selectedDate);
            console.log('üîç Raw booked times for', selectedDate, ':', bookedTimes);
            
            // Clear loading message
            timeSelect.innerHTML = '<option value="">Select a time</option>';
            
            let blockedCount = 0;
            
            // Add time options (excluding booked times)
            allTimes.forEach(time => {
                // Check both the exact format and alternative formats
                const exactMatch = bookedTimes.includes(time);
                const time24 = convertTo24Hour(time);
                const has24Match = bookedTimes.includes(time24);
                const hasConvertedMatch = bookedTimes.some(bookedTime => convertTo12Hour(bookedTime) === time);
                
                const isBooked = exactMatch || has24Match || hasConvertedMatch;
                
                if (isBooked) {
                    blockedCount++;
                    console.log(`üö´ BLOCKING: ${time} (exact=${exactMatch}, 24hr(${time24})=${has24Match}, converted=${hasConvertedMatch})`);
                }
                
                const option = document.createElement('option');
                option.value = time;
                
                if (isBooked) {
                    // Make it super obvious with emojis and different text
                    option.textContent = `üö´ ${time} (UNAVAILABLE)`;
                    option.disabled = true;
                    option.className = 'blocked-time';
                    
                    // Try multiple styling approaches
                    option.style.cssText = 'color: #999 !important; font-weight: bold !important; background-color: #f8f8f8 !important; font-style: italic !important;';
                    option.setAttribute('style', 'color: #999 !important; font-weight: bold !important; background-color: #f8f8f8 !important; font-style: italic !important;');
                    
                    // Set individual style properties as backup
                    option.style.color = '#999';
                    option.style.fontWeight = 'bold';
                    option.style.backgroundColor = '#f8f8f8';
                    option.style.fontStyle = 'italic';
                    
                    console.log(`üé® Created BLOCKED option for ${time}:`, {
                        text: option.textContent,
                        disabled: option.disabled,
                        className: option.className,
                        styles: option.style.cssText,
                        computedColor: window.getComputedStyle ? 'will check after append' : 'n/a'
                    });
                } else {
                    option.textContent = `‚úÖ ${time}`;
                    option.className = 'available-time';
                    option.style.cssText = 'color: #333 !important;';
                    console.log(`‚úÖ Created available option for ${time}`);
                }
                
                timeSelect.appendChild(option);
            });
            
            console.log(`‚úÖ Time options updated: ${allTimes.length} total, ${blockedCount} blocked, ${allTimes.length - blockedCount} available`);
            
            // Force DOM refresh to ensure styles are applied
            timeSelect.style.display = 'none';
            setTimeout(() => {
                timeSelect.style.display = '';
                console.log('üîÑ Forced DOM refresh for time select styling');
            }, 10);
            
            // Add visual indicator if there are blocked times
            if (blockedCount > 0) {
                const timeLabel = document.querySelector('label[for="time"]');
                if (timeLabel) {
                    timeLabel.style.color = '#e74c3c';
                    timeLabel.innerHTML = `Preferred Time: <small style="color: #e74c3c;">(${blockedCount} unavailable)</small>`;
                    
                    // Reset after 3 seconds
                    setTimeout(() => {
                        timeLabel.style.color = '';
                        timeLabel.innerHTML = 'Preferred Time:';
                    }, 3000);
                }
            }
        }
        
        // Basic form setup since external script is disabled
        function setupBasicForm() {
            // Set minimum date to today and restrict blocked dates
            const dateInput = document.getElementById('date');
            if (dateInput) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.min = today;
                
                // Auto-select today as default
                dateInput.value = today;
                
                // Set up blocked dates restriction using a more aggressive approach
                setBlockedDatesRestriction(dateInput);
                
                // Add date change listener with blocked date validation
                dateInput.addEventListener('change', function() {
                    const selectedDate = this.value;
                    console.log('üìÖ Date changed to:', selectedDate);
                    
                    // Check if the selected date is blocked
                    if (selectedDate && isDateBlocked(selectedDate)) {
                        // Show error message and reset to today
                        const today = new Date().toISOString().split('T')[0];
                        alert('‚ùå Sorry, this date is not available for appointments. Please select a different date.');
                        this.value = today;
                        
                        // Update times for today instead
                        console.log('üîÑ Resetting to today and updating times...');
                        updateAvailableTimes();
                        return;
                    }
                    
                    console.log('üîÑ About to call updateAvailableTimes...');
                    updateAvailableTimes();
                    console.log('‚úÖ updateAvailableTimes call completed');
                });
            }
            
            // Auto-populate time options with availability checking
            const timeSelect = document.getElementById('time');
            if (timeSelect) {
                // Initial population
                updateAvailableTimes();
            }
            
            // Auto-update price when service changes (improved logic)
            const serviceSelect = document.getElementById('service');
            const priceSpan = document.getElementById('totalPrice');
            if (serviceSelect && priceSpan) {
                function updatePrice() {
                    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                    const price = selectedOption.getAttribute('data-price') || '0';
                    
                    console.log('üîß BEFORE UPDATE - Display shows:', priceSpan.textContent);
                    priceSpan.textContent = price;
                    console.log('üîß AFTER UPDATE - Should show:', price, 'Actually shows:', priceSpan.textContent);
                    console.log('üí∞ Price updated to:', price, 'for service:', selectedOption.text);
                    
                    // Force a visual update
                    priceSpan.style.color = '#28a745';
                    priceSpan.style.fontWeight = 'bold';
                    
                    // Check if there are multiple elements with same content
                    const allPriceElements = document.querySelectorAll('*[id*="price"], *[class*="price"], span');
                    console.log('üîç Found', allPriceElements.length, 'potential price elements');
                    allPriceElements.forEach((el, index) => {
                        if (el.textContent && el.textContent.match(/\d+/)) {
                            console.log(`üîç Element ${index}:`, el.tagName, el.id, el.className, '‚Üí', el.textContent);
                        }
                    });
                }
                
                serviceSelect.addEventListener('change', updatePrice);
                
                // Set initial price based on current selection
                if (serviceSelect.selectedIndex > 0) {
                    updatePrice();
                } else {
                    // Default to first service price if none selected
                    priceSpan.textContent = '0';
                }
                
                // Trigger price update on page load if service is pre-selected
                setTimeout(updatePrice, 100);
                
            }
        }
        
        // Check if a date is blocked by admin
        function isDateBlocked(date) {
            console.log('üîç Checking if date is blocked:', date);
            
            // Get blocked dates from shared data
            const blockedDates = window.getBlockedDates ? window.getBlockedDates() : [];
            console.log('üîç Available blocked dates:', blockedDates);
            
            // Check if the date is in the blocked dates list
            const isBlocked = blockedDates.some(blocked => {
                // Handle different date formats
                const blockedDate = blocked.date || blocked;
                return blockedDate === date;
            });
            
            if (isBlocked) {
                console.log('üö´ Date is blocked:', date);
            } else {
                console.log('‚úÖ Date is available:', date);
            }
            
            return isBlocked;
        }
        
        // Set up blocked dates restriction for native date input
        function setBlockedDatesRestriction(dateInput) {
            console.log('üîß Setting up blocked dates restriction for native date picker');
            
            // Unfortunately, we cannot directly gray out dates in the native HTML5 date picker
            // The best we can do is prevent selection and show feedback
            
            // Add input event listener to catch any date input changes
            dateInput.addEventListener('input', function() {
                const selectedDate = this.value;
                if (selectedDate && isDateBlocked(selectedDate)) {
                    // Clear the invalid selection
                    this.value = '';
                    // Show a tooltip-like message
                    showDateBlockedMessage(this);
                }
            });
            
            // Add blur event to catch manual typing
            dateInput.addEventListener('blur', function() {
                const selectedDate = this.value;
                if (selectedDate && isDateBlocked(selectedDate)) {
                    const today = new Date().toISOString().split('T')[0];
                    this.value = today;
                    alert('‚ùå Sorry, the selected date is not available for appointments.');
                }
            });
        }
        
        // Show a temporary message for blocked dates
        function showDateBlockedMessage(dateInput) {
            // Create or update message element
            let messageEl = document.getElementById('date-blocked-message');
            if (!messageEl) {
                messageEl = document.createElement('div');
                messageEl.id = 'date-blocked-message';
                messageEl.style.cssText = `
                    position: absolute;
                    background: #fee;
                    border: 1px solid #fcc;
                    color: #c66;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-size: 14px;
                    z-index: 1000;
                    white-space: nowrap;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                `;
                dateInput.parentNode.style.position = 'relative';
                dateInput.parentNode.appendChild(messageEl);
            }
            
            messageEl.textContent = 'This date is not available';
            messageEl.style.display = 'block';
            
            // Position it below the input
            const rect = dateInput.getBoundingClientRect();
            const parentRect = dateInput.parentNode.getBoundingClientRect();
            messageEl.style.top = (rect.bottom - parentRect.top + 5) + 'px';
            messageEl.style.left = (rect.left - parentRect.left) + 'px';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                if (messageEl) {
                    messageEl.style.display = 'none';
                }
            }, 3000);
        }

        // Auto-populate service from URL parameter
        function autoPopulateServiceFromURL() {
            console.log('üîç Auto-populate function called');
            
            // Get URL parameters (check both search params and hash)
            let serviceParam = null;
            
            // First try URL search parameters (?service=...)
            const urlParams = new URLSearchParams(window.location.search);
            serviceParam = urlParams.get('service');
            
            // If not found, try hash parameters (#service=...)
            if (!serviceParam && window.location.hash) {
                const hash = window.location.hash.substring(1);
                const hashParams = new URLSearchParams(hash);
                serviceParam = hashParams.get('service');
            }
            
            console.log('URL:', window.location.href);
            console.log('Service parameter:', serviceParam);
            
            if (!serviceParam) {
                console.log('No service parameter found');
                return;
            }
            
            // Find service dropdown
            const serviceSelect = document.getElementById('service');
            if (!serviceSelect) {
                console.log('Service dropdown not found');
                return;
            }
            
            // Debug: Show all available options
            const allOptions = serviceSelect.querySelectorAll('option');
            console.log('Available options:');
            allOptions.forEach(option => {
                console.log(`- "${option.value}" (${option.textContent})`);
            });
            
            // Find matching option
            const targetOption = serviceSelect.querySelector(`option[value="${serviceParam}"]`);
            if (!targetOption) {
                console.log('‚ùå No matching option found for:', serviceParam);
                console.log('Available option values:', Array.from(allOptions).map(opt => opt.value));
                return;
            }
            
            console.log('Found matching option:', targetOption);
            
            // Set the selection
            serviceSelect.value = serviceParam;
            
            // Update price display
            const price = targetOption.dataset.price || '0';
            const priceElement = document.getElementById('totalPrice');
            if (priceElement) {
                priceElement.textContent = price;
            }
            
            // Visual feedback
            serviceSelect.style.backgroundColor = '#e8f5e8';
            serviceSelect.style.border = '2px solid #27ae60';
            
            // Trigger change event to update calendar
            serviceSelect.dispatchEvent(new Event('change'));
            
            console.log('‚úÖ Service auto-populated:', serviceParam, 'Price:', price);
        }
        
        // Calendar state
        let currentCalendarDate = new Date();
        currentCalendarDate.setDate(1); // Start at first of month
        
        // Generate full monthly calendar
        function generateMonthlyCalendar() {
            const calendarDiv = document.getElementById('calendar');
            if (!calendarDiv) {
                console.warn('‚ùå Calendar div not found!');
                return;
            }
            
            console.log('üìÖ üîÑ GENERATING MONTHLY CALENDAR for:', currentCalendarDate.toLocaleDateString());
            console.log('üìÖ üîÑ Current appointments in system:', window.sharedAppointments?.length || 0);
            
            // Force fresh appointment data load to ensure calendar accuracy
            console.log('üìÖ üîÑ FORCING FRESH DATA LOAD for calendar generation...');
            if (window.getAppointments) {
                const freshAppointments = window.getAppointments();
                window.sharedAppointments = freshAppointments;
                console.log('üìÖ üîÑ Refreshed appointment data:', freshAppointments.length, 'appointments loaded');
            }
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const today = new Date();
            
            // Calendar header with navigation
            let calendarHTML = `
                <div class="calendar-header">
                    <button class="nav-btn" onclick="navigateMonth(-1)">‚Äπ</button>
                    <h3 class="month-year">${currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h3>
                    <button class="nav-btn" onclick="navigateMonth(1)">‚Ä∫</button>
                </div>
                <div class="calendar-weekdays">
                    <div class="weekday">Sun</div>
                    <div class="weekday">Mon</div>
                    <div class="weekday">Tue</div>
                    <div class="weekday">Wed</div>
                    <div class="weekday">Thu</div>
                    <div class="weekday">Fri</div>
                    <div class="weekday">Sat</div>
                </div>
                <div class="calendar-grid">
            `;
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay()); // Start from Sunday
            
            // Generate 6 weeks (42 days) to cover all possible month layouts
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dateStr = date.toISOString().split('T')[0];
                const dayNum = date.getDate();
                const isCurrentMonth = date.getMonth() === month;
                const isPast = date < today.setHours(0,0,0,0);
                const isToday = date.toDateString() === today.toDateString();
                
                let dayClass = 'calendar-day';
                if (!isCurrentMonth) dayClass += ' other-month';
                if (isPast) dayClass += ' past';
                if (isToday) dayClass += ' today';
                
                // Check if date is blocked by admin
                const isBlocked = isDateBlocked(dateStr);
                if (isBlocked) {
                    dayClass += ' blocked';
                    console.log('üö´ Date blocked by admin:', dateStr);
                }
                
                // Check availability for current month dates
                let availabilityInfo = '';
                if (isCurrentMonth && !isPast && !isBlocked) {
                    console.log('üìÖ Calendar slot calculation for:', dateStr);
                    
                    const availableTimes = getAvailableTimesForDate(dateStr);
                    const isAvailable = availableTimes.length > 0;
                    
                    console.log('üìÖ Calendar availability calculated:', { date: dateStr, slots: availableTimes.length });
                    
                    if (isAvailable) {
                        dayClass += ' available';
                        availabilityInfo = `<div class="availability-indicator">${availableTimes.length} slots</div>`;
                    } else {
                        dayClass += ' fully-booked';
                        availabilityInfo = `<div class="availability-indicator">Full</div>`;
                    }
                } else if (isBlocked) {
                    availabilityInfo = `<div class="availability-indicator">Blocked</div>`;
                }
                
                const clickHandler = (isCurrentMonth && !isPast && !isBlocked) ? `onclick="selectDate('${dateStr}')"` : '';
                
                calendarHTML += `
                    <div class="${dayClass}" ${clickHandler} data-date="${dateStr}">
                        <div class="day-number">${dayNum}</div>
                        ${availabilityInfo}
                    </div>
                `;
            }
            
            calendarHTML += '</div>';
            calendarDiv.innerHTML = calendarHTML;
            
            console.log('‚úÖ Monthly calendar generated');
        }
        
        function navigateMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            console.log('üìÖ Navigating to:', currentCalendarDate.toLocaleDateString());
            generateMonthlyCalendar();
        }
        
        // Test function to force calendar refresh
        function forceCalendarRefresh() {
            console.log('üîÑ FORCING CALENDAR REFRESH...');
            initializeAppointmentData();
            generateMonthlyCalendar();
            console.log('‚úÖ Calendar refresh completed');
        }
        
        // Make it globally available for testing
        window.forceCalendarRefresh = forceCalendarRefresh;
        
        // Monitor for appointment changes and refresh calendar
        let lastAppointmentCount = 0;
        let lastAppointmentHash = '';
        
        function monitorAppointmentChanges() {
            const currentCount = window.sharedAppointments?.length || 0;
            
            // Create a hash of appointment data to detect any changes, not just count
            const appointmentHash = window.sharedAppointments ? 
                JSON.stringify(window.sharedAppointments.map(apt => `${apt.date}-${apt.time}-${apt.status}`).sort()) : '';
            
            if (currentCount !== lastAppointmentCount || appointmentHash !== lastAppointmentHash) {
                console.log('üö® APPOINTMENT DATA CHANGED!');
                console.log('üö® Count change:', lastAppointmentCount, '=>', currentCount);
                console.log('üö® Data change detected:', lastAppointmentHash !== appointmentHash);
                console.log('üö® Triggering calendar refresh...');
                
                lastAppointmentCount = currentCount;
                lastAppointmentHash = appointmentHash;
                
                // Force immediate calendar refresh
                setTimeout(() => {
                    generateMonthlyCalendar();
                }, 100); // Small delay to ensure data is settled
            }
        }
        
        // Check for appointment changes frequently
        setInterval(monitorAppointmentChanges, 500); // Check every half second for faster updates
        
        function getAvailableTimesForDate(date) {
            // Use the same time slots as the booking form
            const allTimes = ['10:00 AM', '11:00 AM', '12:00 PM', '1:00 PM', '2:00 PM', '3:00 PM'];
            
            // Force fresh data load to ensure synchronization
            if (!window.sharedAppointments && window.getAppointments) {
                console.log('üîÑ üìÖ CALENDAR: Loading fresh appointment data...');
                initializeAppointmentData();
            }
            
            const bookedTimes24hr = getBookedTimesForDate(date);
            
            // Convert booked times from 24-hour format to 12-hour format for comparison
            const bookedTimes12hr = bookedTimes24hr.map(time24 => {
                return convertTo12Hour(time24);
            });
            
            const availableTimes = allTimes.filter(time => !bookedTimes12hr.includes(time));
            
            console.log('üïí üìÖ CALENDAR AVAILABILITY CHECK for', date);
            console.log('üïí üìÖ All times:', allTimes);
            console.log('üïí üìÖ Booked times (24hr):', bookedTimes24hr);
            console.log('üïí üìÖ Booked times (12hr):', bookedTimes12hr);
            console.log('üïí üìÖ Available times:', availableTimes);
            console.log('üïí üìÖ RESULT:', availableTimes.length, 'slots available');
            console.log('üïí üìÖ Current appointment count in system:', window.sharedAppointments?.length || 0);
            
            return availableTimes;
        }
        
        function selectDate(dateStr) {
            console.log('üìÖ Date selected:', dateStr);
            
            // Check if the selected date is blocked
            if (isDateBlocked(dateStr)) {
                alert('‚ùå Sorry, this date is not available for appointments. Please select a different date.');
                console.log('üö´ Blocked date selection prevented:', dateStr);
                return;
            }
            
            const dateInput = document.getElementById('date');
            if (dateInput) {
                dateInput.value = dateStr;
                updateAvailableTimes();
            }
            
            // Update visual selection
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });
            document.querySelector(`[data-date="${dateStr}"]`)?.classList.add('selected');
        }
        
        // Setup login form handling
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up login form handlers... - v' + Date.now());
            
            // Initialize appointment data for time blocking
            initializeAppointmentData();
            
            // Setup basic form functionality
            setupBasicForm();
            
            // Force a time update for today's date on load
            const dateInput = document.getElementById('date');
            if (dateInput) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
                console.log('üîÑ Auto-setting date to today and updating times');
                setTimeout(updateAvailableTimes, 500);
            }
            
            // Generate initial calendar
            generateMonthlyCalendar();
            
            // Set up periodic calendar refresh to catch any missed updates
            setInterval(() => {
                console.log('üîÑ Periodic calendar refresh...');
                generateMonthlyCalendar();
            }, 10000); // Refresh every 10 seconds
            
            // Auto-populate service if coming from services page
            setTimeout(() => {
                autoPopulateServiceFromURL();
            }, 100);
            
            // Backup auto-populate call after a longer delay
            setTimeout(() => {
                const serviceSelect = document.getElementById('service');
                if (serviceSelect && !serviceSelect.value) {
                    console.log('üîÑ Backup auto-populate call...');
                    autoPopulateServiceFromURL();
                }
            }, 500);
            
            // Listen for hash changes to handle navigation with hash parameters
            window.addEventListener('hashchange', () => {
                console.log('üîç Hash changed, re-running auto-populate');
                autoPopulateServiceFromURL();
            });
            
            // Check for existing user session on page load (with delay to ensure CookieSessionManager is ready)
            setTimeout(checkUserSession, 300);
            
            // Listen for authentication events
            window.addEventListener('userAuthChanged', (event) => {
                console.log('üìÖ User authentication changed, refreshing booking form');
                setTimeout(checkUserSession, 100);
            });
            
            window.addEventListener('userLoggedOut', () => {
                console.log('üìÖ User logged out, clearing booking form');
                setTimeout(checkUserSession, 100);
            });
            
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('Login form submitted');
                    
                    const email = document.getElementById('loginEmail').value;
                    const password = document.getElementById('loginPassword').value;
                    
                    console.log('Login attempt:', email);
                    
                    // Simple demo authentication
                    const authenticatedUser = window.authenticateUser ? window.authenticateUser(email, password) : null;
                    if (authenticatedUser) {
                        // Store user in CookieSessionManager for consistency
                        if (window.CookieSessionManager) {
                            window.CookieSessionManager.login(authenticatedUser);
                        }
                        
                        // Dispatch authentication event for auto-population
                        window.dispatchEvent(new CustomEvent('userAuthChanged', { detail: { user: authenticatedUser } }));
                        
                        Toast.success('Login successful! Your booking has been confirmed:\n' + 
                              `‚Ä¢ Service: ${window.pendingBookingData?.service || 'N/A'}\n` +
                              `‚Ä¢ Date: ${window.pendingBookingData?.date || 'N/A'}\n` +
                              `‚Ä¢ Time: ${window.pendingBookingData?.time || 'N/A'}\n` +
                              `‚Ä¢ Total: $${window.pendingBookingData?.price || '0'}\n\n` +
                              'Appointment ID: ' + Date.now());
                        closeLoginModal();
                        
                        // Trigger form auto-population refresh
                        setTimeout(() => {
                            window.dispatchEvent(new CustomEvent('refreshBookingForm'));
                        }, 100);
                    } else {
                        Toast.error('Invalid credentials. Please check your email and password, or create a new account.', 'Login Failed');
                    }
                });
            }
            
            console.log('Inline handlers setup complete');
        });
        
        // Test function for time slot blocking
        function testTimeSlotBlocking() {
            console.log('üîß Testing time slot blocking...');
            
            const dateInput = document.getElementById('date');
            const testDate = dateInput ? dateInput.value : '2025-08-06';
            
            console.log('Testing date:', testDate);
            
            // Check booked times
            const bookedTimes = getBookedTimesForDate(testDate);
            
            // Show results
            alert(`üîß Time Slot Blocking Test Results:\n\n` +
                  `Date: ${testDate}\n` +
                  `Total appointments in system: ${window.sharedAppointments?.length || 0}\n` +
                  `Booked times for this date: ${bookedTimes.length > 0 ? bookedTimes.join(', ') : 'None'}\n\n` +
                  `Check console for detailed logs.`);
                  
            // Force refresh time slots
            updateAvailableTimes();
        }
        
        // Debug function to check shared data status
        function debugSharedDataStatus() {
            console.log('üîç === SHARED DATA DEBUG STATUS ===');
            console.log('window.sharedAppointments:', window.sharedAppointments);
            console.log('window.addAppointment type:', typeof window.addAppointment);
            console.log('window.getAppointments type:', typeof window.getAppointments);
            console.log('localStorage massageAppointments:', localStorage.getItem('massageAppointments'));
            
            if (window.getAppointments) {
                const appointments = window.getAppointments();
                console.log('Appointments from getAppointments():', appointments.length, appointments);
            }
            
            alert('Check console for shared data debug information');
        }
        
        // Test function to create a test appointment
        function createTestAppointment() {
            console.log('üß™ Creating test appointment...');
            
            // Use today's date for the test
            const today = new Date().toISOString().split('T')[0];
            
            const testAppointment = {
                userId: 2, // John Doe's ID
                clientName: 'Test User',
                email: 'test@example.com',
                phone: '(555) 123-4567',
                service: 'Swedish Massage',
                date: today,
                time: '2:00 PM',
                price: 120,
                status: 'confirmed',
                notes: 'Test appointment for time blocking',
                paymentStatus: 'paid',
                paymentMethod: 'Test',
                transactionId: 'test_123'
            };
            
            console.log('üß™ Test appointment data:', testAppointment);
            
            // Ensure appointment data is loaded first
            initializeAppointmentData();
            
            try {
                const savedAppointment = saveAppointment(testAppointment);
                console.log('‚úÖ Test appointment saved:', savedAppointment);
                
                // Test the time blocking immediately
                const bookedTimes = getBookedTimesForDate(today);
                console.log('üß™ Booked times for', today, ':', bookedTimes);
                
                // Auto-select today's date to show the blocked time
                const dateInput = document.getElementById('date');
                if (dateInput) {
                    dateInput.value = today;
                    updateAvailableTimes();
                }
                
                if (bookedTimes.includes('2:00 PM')) {
                    alert(`‚úÖ Test appointment created for ${today} at 2:00 PM!\n\nTime blocking is working correctly - 2:00 PM should now be unavailable.`);
                } else {
                    alert(`‚ö†Ô∏è Test appointment created for ${today} at 2:00 PM, but time blocking may not be working correctly.`);
                }
                
            } catch (error) {
                console.error('‚ùå Failed to create test appointment:', error);
                alert('Failed to create test appointment: ' + error.message);
            }
        }
        
        // Test function to verify date blocking works
        function testDateBlocking() {
            console.log('üö´ Testing date blocking functionality...');
            
            const today = new Date().toISOString().split('T')[0];
            
            // First, check current available times for today
            const dateInput = document.getElementById('date');
            const timeSelect = document.getElementById('time');
            
            if (dateInput) {
                dateInput.value = today;
                updateAvailableTimes();
            }
            
            console.log('üö´ Current time options before test appointment:');
            if (timeSelect) {
                Array.from(timeSelect.options).forEach((option, index) => {
                    console.log(`  ${index}: ${option.value} - ${option.textContent} (disabled: ${option.disabled})`);
                });
            }
            
            // Create a test appointment for 11:00 AM
            const testAppointment = {
                id: Date.now(),
                clientName: 'Date Blocking Test',
                email: 'test@blocking.com',
                phone: '(555) 999-0000',
                service: 'Thai Stretch',
                date: today,
                time: '11:00 AM',
                price: 120,
                status: 'confirmed',
                notes: 'Test appointment for date blocking verification',
                paymentStatus: 'paid',
                paymentMethod: 'Test',
                transactionId: 'blocking_test_123'
            };
            
            console.log('üö´ Creating test appointment:', testAppointment);
            
            // Initialize and save the appointment
            initializeAppointmentData();
            const savedAppointment = saveAppointment(testAppointment);
            
            if (savedAppointment) {
                console.log('üö´ Test appointment saved, checking if 11:00 AM is now blocked...');
                
                // Refresh times and check
                updateAvailableTimes();
                
                console.log('üö´ Time options after creating test appointment:');
                let elevenAmBlocked = false;
                if (timeSelect) {
                    Array.from(timeSelect.options).forEach((option, index) => {
                        console.log(`  ${index}: ${option.value} - ${option.textContent} (disabled: ${option.disabled})`);
                        if (option.value === '11:00 AM' && option.disabled) {
                            elevenAmBlocked = true;
                        }
                    });
                }
                
                // Test the getBookedTimesForDate function directly
                const bookedTimes = getBookedTimesForDate(today);
                console.log('üö´ Direct booked times check:', bookedTimes);
                
                const isBlocked = bookedTimes.includes('11:00 AM');
                
                if (isBlocked && elevenAmBlocked) {
                    alert(`‚úÖ Date blocking test PASSED!\n\n11:00 AM on ${today} is now properly blocked.\n\nCheck the time dropdown - 11:00 AM should show as "Unavailable".`);
                } else {
                    alert(`‚ùå Date blocking test FAILED!\n\nExpected: 11:00 AM blocked\nActual: ${isBlocked ? 'Blocked in data' : 'Not blocked in data'}, ${elevenAmBlocked ? 'Disabled in UI' : 'Not disabled in UI'}\n\nCheck console for details.`);
                }
            } else {
                alert('‚ùå Failed to create test appointment for date blocking test');
            }
        }

        // Test function to simulate the full booking flow
        function testFullBookingFlow() {
            console.log('üîÑ Testing full booking flow...');
            
            const today = new Date().toISOString().split('T')[0];
            
            // Step 1: Create appointment with pending status (like normal booking)
            const pendingAppointment = {
                id: Date.now(),
                clientName: 'Full Flow Test',
                email: 'fullflow@test.com',
                phone: '(555) 777-8888',
                service: 'Deep Tissue',
                date: today,
                time: '12:00 PM',
                price: 130,
                status: 'pending',
                paymentStatus: 'pending',
                notes: 'Full booking flow test'
            };
            
            console.log('üîÑ Step 1: Creating pending appointment:', pendingAppointment);
            
            // Initialize and save the pending appointment
            initializeAppointmentData();
            const savedPendingAppointment = saveAppointment(pendingAppointment);
            
            if (!savedPendingAppointment) {
                alert('‚ùå Failed to create pending appointment');
                return;
            }
            
            console.log('üîÑ Step 1 Complete: Pending appointment saved:', savedPendingAppointment);
            
            // Step 2: Check if 12:00 PM is blocked (should be, since we check for 'pending' status)
            let bookedTimes = getBookedTimesForDate(today);
            console.log('üîÑ Step 2: Booked times after pending appointment:', bookedTimes);
            
            const isPendingBlocked = bookedTimes.includes('12:00 PM');
            console.log('üîÑ Step 2 Result: 12:00 PM blocked after pending save:', isPendingBlocked);
            
            // Step 3: Simulate payment success - update to confirmed
            console.log('üîÑ Step 3: Simulating payment success...');
            
            let finalAppointment;
            if (window.updateAppointment && savedPendingAppointment.id) {
                finalAppointment = window.updateAppointment(savedPendingAppointment.id, {
                    paymentStatus: 'paid',
                    paymentMethod: 'Stripe',
                    transactionId: `test_${Date.now()}`,
                    status: 'confirmed'
                });
                console.log('üîÑ Step 3: Appointment updated to confirmed:', finalAppointment);
            }
            
            if (!finalAppointment) {
                alert('‚ùå Failed to update appointment to confirmed');
                return;
            }
            
            // Step 4: Refresh and check blocking again
            console.log('üîÑ Step 4: Refreshing data and checking time blocking...');
            initializeAppointmentData();
            updateAvailableTimes();
            
            bookedTimes = getBookedTimesForDate(today);
            console.log('üîÑ Step 4: Booked times after confirmed update:', bookedTimes);
            
            const isConfirmedBlocked = bookedTimes.includes('12:00 PM');
            console.log('üîÑ Step 4 Result: 12:00 PM blocked after confirmed update:', isConfirmedBlocked);
            
            // Step 5: Check for duplicates
            console.log('üîÑ Step 5: Checking for duplicate appointments...');
            const allAppointments = window.getAppointments();
            const testAppointments = allAppointments.filter(apt => 
                apt.date === today && apt.time === '12:00 PM' && apt.email === 'fullflow@test.com'
            );
            console.log('üîÑ Step 5: Found', testAppointments.length, 'matching appointments:', testAppointments);
            
            // Auto-select today's date to show the UI
            const dateInput = document.getElementById('date');
            if (dateInput) {
                dateInput.value = today;
                updateAvailableTimes();
            }
            
            // Results
            const results = {
                pendingCreated: !!savedPendingAppointment,
                pendingBlocked: isPendingBlocked,
                confirmedUpdated: !!finalAppointment,
                confirmedBlocked: isConfirmedBlocked,
                duplicateCount: testAppointments.length
            };
            
            console.log('üîÑ Full Flow Test Results:', results);
            
            let message = `üîÑ Full Booking Flow Test Results:\n\n`;
            message += `‚úÖ Pending appointment created: ${results.pendingCreated}\n`;
            message += `${results.pendingBlocked ? '‚úÖ' : '‚ùå'} Time blocked after pending: ${results.pendingBlocked}\n`;
            message += `‚úÖ Appointment updated to confirmed: ${results.confirmedUpdated}\n`;
            message += `${results.confirmedBlocked ? '‚úÖ' : '‚ùå'} Time blocked after confirmed: ${results.confirmedBlocked}\n`;
            message += `${results.duplicateCount === 1 ? '‚úÖ' : '‚ùå'} No duplicates (found ${results.duplicateCount})\n\n`;
            
            if (results.pendingBlocked && results.confirmedBlocked && results.duplicateCount === 1) {
                message += `üéâ ALL TESTS PASSED! Time blocking is working correctly.`;
            } else {
                message += `‚ö†Ô∏è Some tests failed. Check console for details.`;
            }
            
            alert(message);
        }

        // Test function to bypass security and verify date blocking works
        function bypassSecurityTest() {
            console.log('üö® Testing appointment booking with security bypass...');
            
            const today = new Date().toISOString().split('T')[0];
            
            // Temporarily store the original localStorage.setItem
            const originalSetItem = localStorage.setItem;
            
            // Bypass security for this test
            localStorage.setItem = function(key, value) {
                console.log('üö® BYPASS: localStorage.setItem called for:', key);
                return originalSetItem.call(this, key, value);
            };
            
            // Create test appointment
            const testAppointment = {
                id: Date.now(),
                clientName: 'Security Bypass Test',
                email: 'bypass@test.com',
                phone: '(555) 999-1111',
                service: 'Applied Neurology',
                date: today,
                time: '1:00 PM',
                price: 150,
                status: 'confirmed',
                paymentStatus: 'paid',
                notes: 'Security bypass test for time blocking'
            };
            
            console.log('üö® Creating bypass appointment:', testAppointment);
            
            try {
                // Use direct array manipulation to bypass security
                if (!window.sharedAppointments) {
                    window.sharedAppointments = [];
                }
                
                window.sharedAppointments.push(testAppointment);
                console.log('üö® Appointment added directly to array');
                
                // Manually save to localStorage with bypass
                originalSetItem.call(localStorage, 'massageAppointments', JSON.stringify(window.sharedAppointments));
                console.log('üö® Saved to localStorage with bypass');
                
                // Test time blocking
                initializeAppointmentData();
                const bookedTimes = getBookedTimesForDate(today);
                console.log('üö® Booked times after bypass:', bookedTimes);
                
                // Update UI
                const dateInput = document.getElementById('date');
                if (dateInput) {
                    dateInput.value = today;
                    updateAvailableTimes();
                }
                
                const isBlocked = bookedTimes.includes('1:00 PM');
                
                if (isBlocked) {
                    alert(`‚úÖ Security bypass test PASSED!\n\n1:00 PM on ${today} is properly blocked.\n\nThis confirms the time blocking logic works - the issue is with the security system.`);
                } else {
                    alert(`‚ùå Security bypass test FAILED!\n\nTime blocking is not working even with security bypassed.`);
                }
                
            } catch (error) {
                console.error('üö® Bypass test error:', error);
                alert('‚ùå Bypass test failed: ' + error.message);
            } finally {
                // Restore original localStorage.setItem
                localStorage.setItem = originalSetItem;
                console.log('üö® Security system restored');
            }
        }

        // Function to check which security version is loaded
        function checkSecurityVersion() {
            console.log('üîç Checking security module version...');
            console.log('üîç window.securityModuleVersion:', window.securityModuleVersion);
            console.log('üîç validateSession function exists:', typeof window.validateSession);
            console.log('üîç simpleHash function exists:', typeof window.simpleHash);
            
            // Check if the user validation bypass is working
            let currentUser = null;
            if (window.CookieSessionManager) {
                currentUser = window.CookieSessionManager.getCurrentUser();
            }
            console.log('üîç Current user from CookieSessionManager:', currentUser);
            
            let message = 'üîç Security Version Check:\n\n';
            message += `Version: ${window.securityModuleVersion || 'Unknown/Old'}\n`;
            message += `validateSession: ${typeof window.validateSession}\n`;
            message += `Current User: ${currentUser?.name || 'None'}\n\n`;
            
            if (window.securityModuleVersion && window.securityModuleVersion.includes('2025.08.13')) {
                message += '‚úÖ Updated security module is loaded!';
            } else {
                message += '‚ùå Old security module still cached. Try hard refresh (Ctrl+F5).';
            }
            
            alert(message);
        }

        // Function to clean up test appointments and duplicates
        function cleanupTestAppointments() {
            console.log('üßπ Cleaning up test appointments...');
            
            if (!window.sharedAppointments) {
                alert('No appointment data to clean');
                return;
            }
            
            const beforeCount = window.sharedAppointments.length;
            console.log('üßπ Before cleanup:', beforeCount, 'appointments');
            
            // Remove test appointments (any appointment with test-related emails or names)
            const testEmails = ['test@test.com', 'test@example.com', 'fullflow@test.com', 'bypass@test.com', 'test@blocking.com'];
            const testNames = ['Test Appointment', 'Full Flow Test', 'Security Bypass Test', 'Date Blocking Test'];
            
            const cleanedAppointments = window.sharedAppointments.filter(apt => {
                const isTestEmail = testEmails.includes(apt.email);
                const isTestName = testNames.includes(apt.clientName);
                const isTestUser = apt.clientName === 'Test User' && apt.email === 'test@example.com';
                
                return !(isTestEmail || isTestName || isTestUser);
            });
            
            // Remove duplicates based on date, time, and email combination
            const uniqueAppointments = cleanedAppointments.filter((apt, index, self) => 
                index === self.findIndex(a => 
                    a.date === apt.date && 
                    a.time === apt.time && 
                    a.email === apt.email
                )
            );
            
            window.sharedAppointments = uniqueAppointments;
            
            const afterCount = window.sharedAppointments.length;
            const removed = beforeCount - afterCount;
            
            console.log('üßπ After cleanup:', afterCount, 'appointments');
            console.log('üßπ Removed:', removed, 'test/duplicate appointments');
            
            // Save to localStorage
            if (window.saveToStorage) {
                window.saveToStorage();
            }
            
            // Refresh time slots
            initializeAppointmentData();
            updateAvailableTimes();
            
            alert(`üßπ Cleanup complete!\n\nRemoved: ${removed} test/duplicate appointments\nRemaining: ${afterCount} appointments\n\nTime slots refreshed.`);
        }

        // Debug function to diagnose time blocking issues
        function debugTimeBlocking() {
            console.log('üîç === TIME BLOCKING DIAGNOSTIC ===');
            
            const dateInput = document.getElementById('date');
            const timeSelect = document.getElementById('time');
            
            // Use the current date from the input, or ask user
            let testDate = dateInput?.value;
            if (!testDate) {
                testDate = prompt('Enter date to test (YYYY-MM-DD):', '2025-08-14') || '2025-08-14';
            }
            
            console.log('üîç Testing date:', testDate);
            console.log('üîç Current date input value:', dateInput?.value);
            
            // Set the date input and trigger change
            if (dateInput) {
                dateInput.value = testDate;
                // Trigger the change event to update times
                dateInput.dispatchEvent(new Event('change'));
            }
            
            // Get appointment data
            initializeAppointmentData();
            const allAppointments = window.getAppointments ? window.getAppointments() : [];
            console.log('üîç Total appointments:', allAppointments.length);
            
            // Filter for test date
            const testDateAppointments = allAppointments.filter(apt => apt.date === testDate);
            console.log('üîç Appointments for test date (' + testDate + '):', testDateAppointments.length);
            testDateAppointments.forEach(apt => {
                console.log('  üìç', apt.time, apt.service, apt.status, apt.clientName);
            });
            
            // Get booked times
            const bookedTimes = getBookedTimesForDate(testDate);
            console.log('üîç Booked times array:', bookedTimes);
            
            // Check current time options in dropdown
            updateAvailableTimes();
            console.log('üîç Time dropdown options:');
            if (timeSelect) {
                Array.from(timeSelect.options).forEach((option, index) => {
                    console.log(`  ${index}: "${option.value}" - "${option.textContent}" (disabled: ${option.disabled})`);
                });
            }
            
            // Test specific times
            const testTimes = ['10:00 AM', '11:00 AM', '12:00 PM', '1:00 PM', '2:00 PM', '3:00 PM'];
            console.log('üîç Checking if times should be blocked:');
            testTimes.forEach(time => {
                // Use the same logic as the main blocking function
                const exactMatch = bookedTimes.includes(time);
                const time24 = convertTo24Hour(time);
                const has24Match = bookedTimes.includes(time24);
                const hasConvertedMatch = bookedTimes.some(bookedTime => convertTo12Hour(bookedTime) === time);
                const shouldBeBlocked = exactMatch || has24Match || hasConvertedMatch;
                
                console.log(`  ${time}: should be blocked = ${shouldBeBlocked} (exact=${exactMatch}, 24hr=${has24Match}, converted=${hasConvertedMatch})`);
            });
            
            let message = `üîç Time Blocking Diagnostic:\n\n`;
            message += `Date: ${testDate}\n`;
            message += `Total appointments: ${allAppointments.length}\n`;
            message += `Appointments for this date: ${testDateAppointments.length}\n`;
            message += `Booked times: ${bookedTimes.length}\n`;
            message += `Dropdown options: ${timeSelect ? timeSelect.options.length : 'N/A'}\n\n`;
            
            if (testDateAppointments.length > 0) {
                message += `Appointments for ${testDate}:\n`;
                testDateAppointments.forEach(apt => {
                    message += `‚Ä¢ ${apt.time} - ${apt.service} (${apt.status})\n`;
                });
                
                message += `\nTime slot status:\n`;
                if (timeSelect) {
                    Array.from(timeSelect.options).forEach((option, index) => {
                        if (option.value) {
                            message += `‚Ä¢ ${option.value}: ${option.disabled ? 'BLOCKED' : 'Available'}\n`;
                        }
                    });
                }
            } else {
                message += `No appointments found for ${testDate}.\n`;
            }
            
            alert(message);
        }

        // Function to clean up duplicate appointments
        function cleanupDuplicateAppointments() {
            if (!window.sharedAppointments) return;
            
            const beforeCount = window.sharedAppointments.length;
            console.log('üßπ Cleaning up duplicate appointments...');
            console.log('Before cleanup:', beforeCount, 'appointments');
            
            // Remove duplicates based on userId, date, time combination
            const uniqueAppointments = [];
            const seen = new Set();
            
            window.sharedAppointments.forEach(apt => {
                const key = `${apt.userId}-${apt.date}-${apt.time}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueAppointments.push(apt);
                } else {
                    console.log('üóëÔ∏è Removing duplicate:', apt);
                }
            });
            
            window.sharedAppointments = uniqueAppointments;
            
            // Save cleaned data
            try {
                localStorage.setItem('massageAppointments', JSON.stringify(window.sharedAppointments));
                console.log('‚úÖ Cleaned appointments saved to localStorage');
            } catch (e) {
                console.error('Failed to save cleaned appointments:', e);
            }
            
            const afterCount = window.sharedAppointments.length;
            console.log('After cleanup:', afterCount, 'appointments');
            console.log('Removed', beforeCount - afterCount, 'duplicates');
            
            // Refresh time slots
            updateAvailableTimes();
            
            alert(`üßπ Cleanup Complete!\n\nBefore: ${beforeCount} appointments\nAfter: ${afterCount} appointments\nRemoved: ${beforeCount - afterCount} duplicates`);
        }
        
        // Emergency modal functions
        function closeEmergencyModal() {
            const modal = document.getElementById('emergencyLoginModal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        }
        
        function fillEmergencyDemo() {
            document.getElementById('emergencyEmail').value = '';
            document.getElementById('emergencyPassword').value = '';
        }
        
        function logoutAndContinue() {
            logoutUser();
            closeEmergencyModal();
            alert('‚úÖ You have been logged out. Fill out the form again to book with a different account.');
        }
        
        // Emergency modal tab functions
        function showEmergencyLoginTab() {
            document.getElementById('emergencyLoginForm').style.display = 'block';
            document.getElementById('emergencyRegisterForm').style.display = 'none';
            
            // Update tab styling
            const loginTab = document.getElementById('emergencyLoginTab');
            const registerTab = document.getElementById('emergencyRegisterTab');
            
            loginTab.style.borderBottom = '3px solid #3A7D99';
            loginTab.style.color = '#3A7D99';
            loginTab.style.fontWeight = 'bold';
            
            registerTab.style.borderBottom = '3px solid transparent';
            registerTab.style.color = 'inherit';
            registerTab.style.fontWeight = 'normal';
        }
        
        function showEmergencyRegisterTab() {
            document.getElementById('emergencyLoginForm').style.display = 'none';
            document.getElementById('emergencyRegisterForm').style.display = 'block';
            
            // Pre-fill registration form with booking data
            if (window.pendingBookingData) {
                const nameField = document.getElementById('emergencyRegisterName');
                const emailField = document.getElementById('emergencyRegisterEmail');
                const phoneField = document.getElementById('emergencyRegisterPhone');
                
                if (nameField && window.pendingBookingData.clientName) {
                    nameField.value = window.pendingBookingData.clientName;
                }
                if (emailField && window.pendingBookingData.email) {
                    emailField.value = window.pendingBookingData.email;
                }
                if (phoneField && window.pendingBookingData.phone) {
                    phoneField.value = window.pendingBookingData.phone;
                }
            }
            
            // Update tab styling
            const loginTab = document.getElementById('emergencyLoginTab');
            const registerTab = document.getElementById('emergencyRegisterTab');
            
            loginTab.style.borderBottom = '3px solid transparent';
            loginTab.style.color = 'inherit';
            loginTab.style.fontWeight = 'normal';
            
            registerTab.style.borderBottom = '3px solid #3A7D99';
            registerTab.style.color = '#3A7D99';
            registerTab.style.fontWeight = 'bold';
        }
        
        function handleEmergencyLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('emergencyEmail').value;
            const password = document.getElementById('emergencyPassword').value;
            
            console.log('üîê Emergency login attempt', { email: email.substring(0, 5) + '***' });
            
            // Use secure authentication system
            
            const authenticatedUser = window.authenticateUser ? window.authenticateUser(email, password) : null;
            if (authenticatedUser) {
                // Find existing user in shared data
                const existingUser = window.sharedUsers.find(u => u.email === email);
                let userSession;
                
                if (existingUser) {
                    userSession = {
                        id: existingUser.id,
                        name: existingUser.name,
                        email: existingUser.email,
                        phone: existingUser.phone,
                        role: existingUser.role,
                        loginTime: new Date().toISOString(),
                        sessionToken: window.generateSecureSessionToken ? window.generateSecureSessionToken() : `fallback_${Date.now()}_${Math.random().toString(36).substr(2, 15)}`,
                        totalAppointments: existingUser.totalAppointments + 1
                    };
                    
                    // Update user's total appointments and last visit
                    window.updateUser(existingUser.id, {
                        totalAppointments: existingUser.totalAppointments + 1,
                        lastVisit: new Date().toISOString()
                    });
                } else {
                    userSession = {
                        id: 2, // Default for John Doe
                        name: 'John Doe',
                        email: 'john.doe@email.com',
                        role: 'user',
                        loginTime: new Date().toISOString(),
                        sessionToken: window.generateSecureSessionToken ? window.generateSecureSessionToken() : `fallback_${Date.now()}_${Math.random().toString(36).substr(2, 15)}`,
                        totalAppointments: 1
                    };
                }
                
                // Create and save the appointment
                const newAppointment = {
                    userId: userSession.id,
                    clientName: userSession.name,
                    email: userSession.email,
                    phone: userSession.phone || window.pendingBookingData?.phone || '',
                    service: getServiceDisplayName(window.pendingBookingData?.service) || 'Selected Service',
                    date: window.pendingBookingData?.date || '',
                    time: window.pendingBookingData?.time || '',
                    price: parseInt(window.pendingBookingData?.price) || 0,
                    status: 'confirmed',
                    notes: window.pendingBookingData?.notes || '',
                    paymentStatus: 'confirmed',
                    paymentMethod: 'Online Booking',
                    transactionId: `txn_${Date.now()}`
                };
                
                // Don't save appointment yet - will save after payment
                // const savedAppointment = saveAppointment(newAppointment);
                
                // Use cookie session manager instead of localStorage
                if (window.CookieSessionManager) {
                    window.CookieSessionManager.login(userSession);
                    console.log('‚úÖ CookieSessionManager updated for existing user');
                } else {
                    console.error('‚ùå CookieSessionManager not available');
                }
                
                // Instead of immediately confirming, show payment modal
                console.log('‚úÖ Login successful, proceeding to payment...');
                closeEmergencyModal();
                
                // Store data for payment processing
                window.pendingAppointment = newAppointment;
                window.currentUserSession = userSession;
                
                // Show payment modal
                showBookingPaymentModal(newAppointment);
                
                // Update navigation to show logged-in state
                updateNavigationForLoggedInUser(userSession);
                
                // Clear form and refresh time slots
                const form = document.getElementById('bookingForm');
                if (form) form.reset();
                
                // Refresh time slots to show the new booking as unavailable
                setTimeout(() => {
                    updateAvailableTimes();
                    console.log('üîÑ Time slots refreshed after booking');
                }, 500);
                
            } else if (authenticatedUser && authenticatedUser.email === 'jane.smith@email.com') {
                // Find existing user in shared data
                const existingUser = window.sharedUsers.find(u => u.email === email);
                let userSession;
                
                if (existingUser) {
                    userSession = {
                        id: existingUser.id,
                        name: existingUser.name,
                        email: existingUser.email,
                        phone: existingUser.phone,
                        role: existingUser.role,
                        loginTime: new Date().toISOString(),
                        sessionToken: window.generateSecureSessionToken ? window.generateSecureSessionToken() : `fallback_${Date.now()}_${Math.random().toString(36).substr(2, 15)}`,
                        totalAppointments: existingUser.totalAppointments + 1
                    };
                    
                    // Update user's total appointments and last visit
                    window.updateUser(existingUser.id, {
                        totalAppointments: existingUser.totalAppointments + 1,
                        lastVisit: new Date().toISOString()
                    });
                } else {
                    userSession = {
                        id: 3, // Default for Jane Smith
                        name: 'Jane Smith',
                        email: 'jane.smith@email.com',
                        role: 'user',
                        loginTime: new Date().toISOString(),
                        sessionToken: window.generateSecureSessionToken ? window.generateSecureSessionToken() : `fallback_${Date.now()}_${Math.random().toString(36).substr(2, 15)}`,
                        totalAppointments: 1
                    };
                }
                
                // Create and save the appointment
                const newAppointment = {
                    userId: userSession.id,
                    clientName: userSession.name,
                    email: userSession.email,
                    phone: userSession.phone || window.pendingBookingData?.phone || '',
                    service: getServiceDisplayName(window.pendingBookingData?.service) || 'Selected Service',
                    date: window.pendingBookingData?.date || '',
                    time: window.pendingBookingData?.time || '',
                    price: parseInt(window.pendingBookingData?.price) || 0,
                    status: 'confirmed',
                    notes: window.pendingBookingData?.notes || '',
                    paymentStatus: 'confirmed',
                    paymentMethod: 'Online Booking',
                    transactionId: `txn_${Date.now()}`
                };
                
                // Don't save appointment yet - will save after payment
                // const savedAppointment = saveAppointment(newAppointment);
                
                // Use cookie session manager instead of localStorage
                if (window.CookieSessionManager) {
                    window.CookieSessionManager.login(userSession);
                    console.log('‚úÖ CookieSessionManager updated for existing user');
                } else {
                    console.error('‚ùå CookieSessionManager not available');
                }
                
                alert('‚úÖ Login successful!\\n\\nWelcome Jane!\\n\\nBooking confirmed:\\n' + 
                      `‚Ä¢ Service: ${newAppointment.service}\\n` +
                      `‚Ä¢ Date: ${newAppointment.date}\\n` +
                      `‚Ä¢ Time: ${newAppointment.time}\\n` +
                      `‚Ä¢ Total: $${newAppointment.price}\\n\\n` +
                      `Appointment will be confirmed after payment\\n\\n` +
                      'üéâ You are now logged in and can book future appointments instantly!\\n\\n' +
                      'üìÖ This time slot is now blocked for other users.');
                      
                closeEmergencyModal();
                updateNavigationForLoggedInUser(userSession);
                
                const form = document.getElementById('bookingForm');
                if (form) form.reset();
            } else if (existingUser) {
                // Handle any registered user
                console.log('‚úÖ Found registered user:', existingUser);
                
                let userSession = {
                    id: existingUser.id,
                    name: existingUser.name,
                    email: existingUser.email,
                    phone: existingUser.phone,
                    role: existingUser.role,
                    loginTime: new Date().toISOString(),
                    totalAppointments: existingUser.totalAppointments + 1
                };
                
                // Update user's total appointments and last visit
                window.updateUser(existingUser.id, {
                    totalAppointments: existingUser.totalAppointments + 1,
                    lastVisit: new Date().toISOString()
                });
                
                // Create and save the appointment
                const newAppointment = {
                    userId: userSession.id,
                    clientName: userSession.name,
                    email: userSession.email,
                    phone: userSession.phone || window.pendingBookingData?.phone || '',
                    service: getServiceDisplayName(window.pendingBookingData?.service) || 'Selected Service',
                    date: window.pendingBookingData?.date || '',
                    time: window.pendingBookingData?.time || '',
                    price: parseInt(window.pendingBookingData?.price) || 0,
                    status: 'confirmed',
                    notes: window.pendingBookingData?.notes || '',
                    paymentStatus: 'confirmed',
                    paymentMethod: 'Online Booking',
                    transactionId: `txn_${Date.now()}`
                };
                
                // Don't save appointment yet - will save after payment
                // const savedAppointment = saveAppointment(newAppointment);
                
                // Use secure session manager instead of localStorage
                if (window.secureSession) {
                    window.secureSession.login(userSession.email, 'secure_session').then(loginResult => {
                        if (!loginResult.success) {
                            console.error('üîê Secure session creation failed');
                        }
                    });
                } else {
                    console.warn('üîê Secure session manager not available, using fallback');
                    localStorage.setItem('sessionToken', 'fallback_' + Date.now());
                    localStorage.setItem('isLoggedIn', 'true');
                }
                
                // Update SimpleSessionManager if available
                if (window.SimpleSessionManager) {
                    window.SimpleSessionManager.login(userSession);
                    console.log('‚úÖ SimpleSessionManager updated for existing user');
                }
                
                // Instead of immediately confirming, show payment modal
                console.log('‚úÖ Login successful, proceeding to payment...');
                closeEmergencyModal();
                
                // Store data for payment processing
                window.pendingAppointment = newAppointment;
                window.currentUserSession = userSession;
                
                // Show payment modal
                showBookingPaymentModal(newAppointment);
                
                updateNavigationForLoggedInUser(userSession);
            } else {
                alert('‚ùå Invalid credentials. Please check your email and password, or create a new account by clicking "Create New Account".');
            }
        }
        
        function handleEmergencyRegister(event) {
            event.preventDefault();
            
            const name = document.getElementById('emergencyRegisterName').value.trim();
            const email = document.getElementById('emergencyRegisterEmail').value.trim();
            const phone = document.getElementById('emergencyRegisterPhone').value.trim();
            const password = document.getElementById('emergencyRegisterPassword').value;
            const confirmPassword = document.getElementById('emergencyConfirmPassword').value;
            
            console.log('üéâ New account registration attempt:', { name, email, phone });
            
            // Validation
            if (!name || !email || !phone || !password || !confirmPassword) {
                alert('‚ùå Please fill in all fields.');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('‚ùå Passwords do not match. Please try again.');
                return;
            }
            
            if (password.length < 6) {
                alert('‚ùå Password must be at least 6 characters long.');
                return;
            }
            
            // Check if email already exists (demo check)
            if (email === 'john.doe@email.com' || email === 'jane.smith@email.com') {
                alert('‚ùå An account with this email already exists. Please use the "Existing Account" tab to login.');
                showEmergencyLoginTab();
                document.getElementById('emergencyEmail').value = email;
                return;
            }
            
            // Create new user with secure password hash
            let passwordHash;
            try {
                if (typeof dcodeIO !== 'undefined' && dcodeIO.bcrypt) {
                    // Generate secure bcrypt hash
                    const salt = dcodeIO.bcrypt.genSaltSync(12);
                    passwordHash = dcodeIO.bcrypt.hashSync(password, salt);
                    console.log('üîí Generated secure bcrypt hash for new user');
                } else {
                    // Fallback to simpleHash (INSECURE)
                    console.warn('üîí bcrypt.js not available, using insecure fallback');
                    passwordHash = simpleHash(password);
                }
            } catch (error) {
                console.error('üîí Password hashing error:', error);
                passwordHash = simpleHash(password); // Fallback
            }

            const newUserData = {
                username: email,
                passwordHash: passwordHash, // Use hashed password instead of plaintext
                name: name,
                email: email,
                phone: phone,
                role: 'user',
                totalAppointments: 1,
                lastVisit: new Date().toISOString(),
                preferences: ''
            };
            
            const savedUser = saveUser(newUserData);
            console.log('‚úÖ New user added to shared data:', savedUser);
            
            // Create user session with security token
            const newUserSession = {
                id: savedUser.id,
                name: savedUser.name,
                email: savedUser.email,
                phone: savedUser.phone,
                role: savedUser.role,
                loginTime: new Date().toISOString(),
                sessionToken: window.generateSecureSessionToken ? window.generateSecureSessionToken() : `fallback_${Date.now()}_${Math.random().toString(36).substr(2, 15)}`,
                totalAppointments: savedUser.totalAppointments,
                isNewUser: true
            };
            
            // Create and save the appointment
            const newAppointment = {
                userId: savedUser.id,
                clientName: savedUser.name,
                email: savedUser.email,
                phone: savedUser.phone,
                service: getServiceDisplayName(window.pendingBookingData?.service) || 'Selected Service',
                date: window.pendingBookingData?.date || '',
                time: window.pendingBookingData?.time || '',
                price: parseInt(window.pendingBookingData?.price) || 0,
                status: 'confirmed',
                notes: window.pendingBookingData?.notes || '',
                paymentStatus: 'confirmed',
                paymentMethod: 'Online Booking',
                transactionId: `txn_${Date.now()}`
            };
            
            // Don't save appointment yet - will save after payment
            // const savedAppointment = window.addAppointment(newAppointment);
            console.log('üìù Appointment prepared for payment:', newAppointment);
            
            // Store user session
            // Use cookie session manager instead of localStorage
            if (window.CookieSessionManager) {
                window.CookieSessionManager.login(newUserSession);
                console.log('‚úÖ CookieSessionManager updated for new user');
            } else {
                console.error('‚ùå CookieSessionManager not available');
            }
            
            // Dispatch authentication event for auto-population
            window.dispatchEvent(new CustomEvent('userAuthChanged', { detail: { user: newUserSession } }));
            
            // Instead of immediately confirming, show payment modal
            console.log('‚úÖ Account created successfully, proceeding to payment...');
            closeEmergencyModal();
            
            // Trigger form auto-population refresh for future bookings
            setTimeout(() => {
                window.dispatchEvent(new CustomEvent('refreshBookingForm'));
            }, 100);
            
            // Store data for payment processing
            window.pendingAppointment = newAppointment;
            window.currentUserSession = newUserSession;
            
            // Show payment modal with account creation success message
            showBookingPaymentModal(newAppointment, true, name);
            
            // Update navigation for the new user
            updateNavigationForLoggedInUser(newUserSession);
        }
        
        // Show Stripe payment modal for booking (using membership payment logic)
        function showBookingPaymentModal(appointment, isNewAccount = false, newUserName = '') {
            console.log('üí≥ Showing booking payment modal for appointment:', appointment);
            
            // Store appointment data for payment success handler
            window.pendingAppointment = appointment;
            
            // Ensure we have the correct price from the appointment data
            const appointmentPrice = parseFloat(appointment.price) || 0;
            console.log('üí≥ Appointment price:', appointmentPrice);
            
            // Validate that we have a valid price
            if (appointmentPrice <= 0) {
                console.error('‚ùå Invalid appointment price:', appointment.price);
                alert('Error: Invalid service price. Please try booking again.');
                return;
            }
            
            // Create payment modal
            const paymentModal = document.createElement('div');
            paymentModal.id = 'bookingPaymentModal';
            paymentModal.className = 'modal';
            paymentModal.style.display = 'flex';
            
            const welcomeMessage = isNewAccount ? 
                `<div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #155724;">üéâ Account Created Successfully!</h4>
                    <p style="margin: 0; color: #155724;">Welcome to Consider Restoration, ${newUserName}!</p>
                </div>` : '';
            
            paymentModal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header" style="background: #3A7D99; color: white; padding: 1rem; margin: -20px -20px 20px -20px; border-radius: 8px 8px 0 0;">
                        <h2 style="margin: 0; font-size: 1.5rem;">üí≥ Complete Your Booking</h2>
                        <span onclick="closeBookingPaymentModal()" style="
                            float: right;
                            font-size: 24px;
                            cursor: pointer;
                            color: white;
                            background: none;
                            border: none;
                            padding: 0;
                            margin-top: -5px;
                        ">&times;</span>
                    </div>
                    <div class="modal-body">
                        ${welcomeMessage}
                        
                        <div class="booking-summary" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #2c3e50;">Appointment Summary</h4>
                            <p style="margin: 0.25rem 0;"><strong>Service:</strong> ${appointment.service}</p>
                            <p style="margin: 0.25rem 0;"><strong>Date:</strong> ${appointment.date}</p>
                            <p style="margin: 0.25rem 0;"><strong>Time:</strong> ${appointment.time}</p>
                            <p style="margin: 0.25rem 0;"><strong>Client:</strong> ${appointment.clientName}</p>
                            <p style="margin: 0.25rem 0;"><strong>Total:</strong> <span style="font-size: 1.2rem; color: #28a745; font-weight: bold;">$${appointment.price}</span></p>
                        </div>
                        
                        <div class="test-cards-info" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #856404;">üß™ Test Mode - Use These Card Numbers:</h4>
                            <div style="font-family: monospace; font-size: 0.9rem;">
                                <p style="margin: 0.25rem 0;"><strong>‚úÖ Success:</strong> 4242 4242 4242 4242</p>
                                <p style="margin: 0.25rem 0;"><strong>‚ùå Decline:</strong> 4000 0000 0000 0002</p>
                                <p style="margin: 0.25rem 0;"><strong>üí≥ Use any future date, any CVC</strong></p>
                            </div>
                        </div>
                        
                        <form id="booking-payment-form">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Card Information:</label>
                                <div id="booking-card-element" style="padding: 12px; border: 1px solid #ddd; border-radius: 5px; background: white;">
                                    <!-- Stripe Elements will create form elements here -->
                                </div>
                                <div id="booking-card-errors" role="alert" style="color: #fa755a; margin-top: 0.5rem;"></div>
                            </div>
                            
                            <button type="submit" id="submit-booking-payment" style="
                                width: 100%;
                                background: #28a745;
                                color: white;
                                border: none;
                                padding: 15px;
                                border-radius: 5px;
                                font-size: 1.1rem;
                                cursor: pointer;
                                transition: background 0.3s;
                                font-weight: bold;
                            ">
                                <span id="booking-button-text">üí≥ Pay $${appointment.price} & Confirm Booking</span>
                                <span id="booking-spinner" style="display: none;">Processing Payment...</span>
                            </button>
                        </form>
                        
                        <p style="font-size: 0.85rem; color: #666; text-align: center; margin-top: 1rem;">
                            üîí Secure payment powered by Stripe<br>
                            Your appointment will be confirmed after payment
                        </p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(paymentModal);
            document.body.style.overflow = 'hidden';
            
            // Initialize Stripe for booking payment
            initializeBookingStripePayment();
        }
        
        // Initialize demo payment form for booking (using membership page logic)
        function initializeBookingStripePayment() {
            console.log('üß™ Initializing demo payment form for booking...');
            
            // Verify appointment data exists
            if (!window.pendingAppointment) {
                console.error('‚ùå No pending appointment data found');
                return;
            }
            
            console.log('üí≥ Processing payment for appointment:', window.pendingAppointment);
            
            // Create demo card input fields instead of using real Stripe Elements
            const cardElementContainer = document.getElementById('booking-card-element');
            cardElementContainer.innerHTML = `
                <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                    <input type="text" id="demo-card-number" placeholder="1234 1234 1234 1234" 
                           style="flex: 2; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;" 
                           maxlength="19">
                    <input type="text" id="demo-expiry" placeholder="MM/YY" 
                           style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;" 
                           maxlength="5">
                    <input type="text" id="demo-cvc" placeholder="CVC" 
                           style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;" 
                           maxlength="4">
                </div>
            `;
            
            // Add card number formatting
            const cardNumberInput = document.getElementById('demo-card-number');
            cardNumberInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || '';
                e.target.value = formattedValue;
            });
            
            // Add expiry formatting
            const expiryInput = document.getElementById('demo-expiry');
            expiryInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0,2) + '/' + value.substring(2,4);
                }
                e.target.value = value;
            });
            
            // Handle form submission
            const form = document.getElementById('booking-payment-form');
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                
                const submitButton = document.getElementById('submit-booking-payment');
                const buttonText = document.getElementById('booking-button-text');
                const spinner = document.getElementById('booking-spinner');
                const errorDisplay = document.getElementById('booking-card-errors');
                
                // Clear any previous errors
                errorDisplay.textContent = '';
                
                // Get form values
                const cardNumber = document.getElementById('demo-card-number').value.replace(/\s/g, '');
                const expiry = document.getElementById('demo-expiry').value;
                const cvc = document.getElementById('demo-cvc').value;
                
                // Basic validation
                if (!cardNumber || cardNumber.length < 13) {
                    errorDisplay.textContent = 'Please enter a valid card number.';
                    return;
                }
                if (!expiry || expiry.length < 5) {
                    errorDisplay.textContent = 'Please enter a valid expiry date.';
                    return;
                }
                if (!cvc || cvc.length < 3) {
                    errorDisplay.textContent = 'Please enter a valid CVC.';
                    return;
                }
                
                // Show loading state
                submitButton.disabled = true;
                buttonText.style.display = 'none';
                spinner.style.display = 'inline';
                
                // Demo payment processing
                setTimeout(() => {
                    // Check for test card numbers
                    if (cardNumber === '4242424242424242') {
                        console.log('üí≥ Demo payment successful with test card!');
                        handleBookingPaymentSuccess();
                    } else if (cardNumber === '4000000000000002') {
                        // Simulate declined card
                        errorDisplay.textContent = 'Your card was declined. Please try again with a different payment method.';
                        submitButton.disabled = false;
                        buttonText.style.display = 'inline';
                        spinner.style.display = 'none';
                    } else {
                        // For any other card number, simulate success for demo purposes
                        console.log('üí≥ Demo payment successful with any card number!');
                        handleBookingPaymentSuccess();
                    }
                }, 2000);
            });
        }
        
        // Handle successful booking payment (using membership page success logic)
        function handleBookingPaymentSuccess() {
            console.log('üéâ Booking payment successful!');
            
            const appointment = window.pendingAppointment;
            
            if (!appointment) {
                console.error('‚ùå No pending appointment found for payment success!');
                alert('Error: No appointment data found. Please try booking again.');
                return;
            }
            
            console.log('üìã Processing payment for appointment:', appointment);
            
            // Ensure price is correctly formatted
            const appointmentPrice = parseFloat(appointment.price) || 0;
            console.log('üí∞ Final appointment price:', appointmentPrice);
            
            console.log('üìã Processing payment for appointment:', appointment);
            
            console.log('üíæ Saving appointment with payment completed');
            
            // Update appointment payment status
            appointment.paymentStatus = 'paid';
            appointment.paymentMethod = 'Stripe';
            appointment.transactionId = `stripe_${Date.now()}`;
            appointment.status = 'confirmed';
            
            // Get current user for debugging
            let currentUser = null;
            if (window.CookieSessionManager) {
                currentUser = window.CookieSessionManager.getCurrentUser();
            }
            
            // Debug: Log appointment data before saving
            console.log('üíæ About to save appointment with data:', appointment);
            console.log('üíæ Current user for verification:', currentUser);
            
            // Update the existing appointment instead of creating a new one
            console.log('üíæ Updating existing appointment with ID:', appointment.id);
            
            let finalAppointment;
            if (window.updateAppointment && appointment.id) {
                // Use updateAppointment to modify the existing appointment
                finalAppointment = window.updateAppointment(appointment.id, {
                    paymentStatus: 'paid',
                    paymentMethod: 'Stripe',
                    transactionId: appointment.transactionId,
                    status: 'confirmed'
                });
                console.log('‚úÖ Appointment updated via updateAppointment:', finalAppointment);
            } else {
                // Fallback to saveAppointment if updateAppointment not available
                console.log('‚ö†Ô∏è updateAppointment not available, using saveAppointment fallback');
                finalAppointment = saveAppointment(appointment);
            }
            
            if (!finalAppointment) {
                console.error('‚ùå Failed to save appointment');
                alert('Error saving appointment. Please contact support.');
                return;
            }
            
            console.log('‚úÖ Final appointment saved:', finalAppointment);
            console.log('‚úÖ Appointment userId:', finalAppointment.userId, 'Current user ID:', currentUser?.id);
            
            // Refresh appointment data and time blocking
            console.log('üîÑ Refreshing appointment data for time blocking...');
            initializeAppointmentData();
            updateAvailableTimes();
            
            // Refresh the calendar to show updated availability
            console.log('üîÑ Refreshing calendar after appointment completion...');
            generateMonthlyCalendar();
            
            // Verify the current user is still available
            if (!currentUser && window.CookieSessionManager) {
                currentUser = window.CookieSessionManager.getCurrentUser();
                console.log('üîÑ Refreshed current user:', currentUser);
            }
            
            // Verify and refresh session data
            if (currentUser && currentUser.id && currentUser.email) {
                console.log('üîê Refreshing session after payment success...');
                
                // Update session with fresh login time and ensure session token exists
                const refreshedUser = {
                    ...currentUser,
                    loginTime: new Date().toISOString(),
                    sessionToken: currentUser.sessionToken || (window.generateSecureSessionToken ? window.generateSecureSessionToken() : `fallback_${Date.now()}_${Math.random().toString(36).substr(2, 15)}`)
                };
                
                // Re-save session using cookie manager
                if (window.CookieSessionManager) {
                    window.CookieSessionManager.login(refreshedUser);
                    console.log('üîê CookieSessionManager updated after payment');
                } else {
                    console.error('‚ùå CookieSessionManager not available');
                }
            }
            
            const userSession = {
                name: currentUser?.name || 'User',
                isNewUser: currentUser?.isNewUser || false
            };
            
            // Note: appointmentAdded event is already dispatched by saveAppointment() function
            // No need to dispatch it again here to avoid duplication
            
            // Close payment modal
            closeBookingPaymentModal();
            
            // Show success modal
            showBookingSuccessModal(finalAppointment, userSession);
        }
        
        // Show booking success modal
        function showBookingSuccessModal(appointment, userSession) {
            const successModal = document.createElement('div');
            successModal.className = 'modal';
            successModal.style.display = 'flex';
            
            const isNewUser = userSession.isNewUser;
            const welcomeText = isNewUser ? 
                `üéâ Welcome to Consider Restoration, ${userSession.name}!` :
                `‚úÖ Welcome back, ${userSession.name}!`;
            
            successModal.innerHTML = `
                <div class="modal-content" style="max-width: 450px; text-align: center;">
                    <div style="padding: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üéâ</div>
                        <h2 style="color: #28a745; margin-bottom: 1rem;">Booking Confirmed!</h2>
                        <p style="margin-bottom: 1.5rem;">${welcomeText}</p>
                        
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 1.5rem; margin: 1rem 0; text-align: left;">
                            <h4 style="margin: 0 0 1rem 0; color: #155724; text-align: center;">Appointment Details</h4>
                            <p style="margin: 0.5rem 0;"><strong>Service:</strong> ${appointment.service}</p>
                            <p style="margin: 0.5rem 0;"><strong>Date:</strong> ${appointment.date}</p>
                            <p style="margin: 0.5rem 0;"><strong>Time:</strong> ${appointment.time}</p>
                            <p style="margin: 0.5rem 0;"><strong>Total:</strong> $${appointment.price}</p>
                            <p style="margin: 0.5rem 0;"><strong>Appointment ID:</strong> ${appointment.id}</p>
                            <p style="margin: 0.5rem 0;"><strong>Status:</strong> <span style="color: #28a745; font-weight: bold;">Confirmed ‚úÖ</span></p>
                        </div>
                        
                        <p style="font-size: 0.9rem; color: #666; margin-bottom: 1.5rem;">
                            ${isNewUser ? '‚ú® Your account is now active! Future bookings will be even faster.<br>' : ''}
                            üìÖ This time slot is now blocked for other users.<br>
                            üìß Check your email for appointment confirmation.
                        </p>
                        
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button onclick="navigateToPortalSafely()" style="
                                background: #3A7D99;
                                color: white;
                                border: none;
                                padding: 0.75rem 1.5rem;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 1rem;
                            ">üë§ View Portal</button>
                            <button onclick="closeBookingSuccessModal(); window.location.reload()" style="
                                background: #28a745;
                                color: white;
                                border: none;
                                padding: 0.75rem 1.5rem;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 1rem;
                            ">üìÖ Book Another</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(successModal);
            
            // Clear form and refresh time slots after success
            setTimeout(() => {
                const form = document.getElementById('bookingForm');
                if (form) form.reset();
                updateAvailableTimes();
                console.log('üîÑ Form cleared and time slots refreshed after booking');
            }, 1000);
            
            // Auto-close after 12 seconds
            setTimeout(() => {
                closeBookingSuccessModal();
            }, 12000);
        }
        
        // Modal management functions for booking payment
        function closeBookingPaymentModal() {
            const modal = document.getElementById('bookingPaymentModal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        }
        
        function closeBookingSuccessModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => modal.remove());
            document.body.style.overflow = '';
        }
        
        // Safe navigation to user portal that ensures session persistence
        function navigateToPortalSafely() {
            console.log('üîê Navigating to portal safely...');
            
            // Ensure session data is properly saved using the correct session manager
            let currentUser = null;
            
            // Try universal session manager first (main system)
            if (window.universalSession) {
                currentUser = window.universalSession.getCurrentUser();
                console.log('üîê Using universalSession for navigation');
            }
            // Fallback to CookieSessionManager if available
            else if (window.CookieSessionManager) {
                currentUser = window.CookieSessionManager.getCurrentUser();
                console.log('üîê Using CookieSessionManager for navigation');
            }
            // Final fallback to direct localStorage check
            else {
                const userSession = localStorage.getItem('user_session_data');
                if (userSession) {
                    try {
                        currentUser = JSON.parse(userSession);
                        console.log('üîê Using localStorage fallback for navigation');
                    } catch (e) {
                        console.warn('üîê Invalid session data in localStorage');
                    }
                }
            }
            
            console.log('üîê Pre-navigation session check:');
            console.log('  - currentUser exists:', !!currentUser);
            console.log('  - Available session managers:');
            console.log('    - universalSession:', !!window.universalSession);
            console.log('    - CookieSessionManager:', !!window.CookieSessionManager);
            
            if (currentUser) {
                console.log('  - User data valid:', currentUser.name, currentUser.email);
                
                try {
                    // Refresh session before navigation using available manager
                    if (window.universalSession) {
                        console.log('üîê Refreshing universalSession before navigation...');
                        window.universalSession.saveSession(currentUser); // Ensure session is saved
                    } else if (window.CookieSessionManager) {
                        console.log('üîê Refreshing CookieSessionManager before navigation...');
                        window.CookieSessionManager.refreshSession();
                    }
                    
                    // Small delay to ensure all data is committed
                    setTimeout(() => {
                        closeBookingSuccessModal();
                        console.log('üîê Navigating to user portal...');
                        window.location.href = 'user-portal.html';
                    }, 100);
                    
                } catch (error) {
                    console.error('üîê Session validation error before navigation:', error);
                    alert('Session error. Please log in again at the user portal.');
                    closeBookingSuccessModal();
                    window.location.href = 'user-portal.html';
                }
            } else {
                console.warn('üîê No valid session found before navigation');
                alert('No session found. You may need to log in again.');
                closeBookingSuccessModal();
                window.location.href = 'user-portal.html';
            }
        }
    </script>

    <!-- Session Management Only (auth-security.js already loaded in head) -->
    <!-- DISABLED session managers on booking page -->
    <!-- <script src="js/cookie-session-manager.js"></script> -->
    <!-- <script src="js/navigation-handler.js"></script> -->
    
    <!-- Modular Booking System -->
    <script src="js/modules/booking/booking-form-handler.js" defer></script>
    <!-- <script src="js/modules/booking/booking-ui-manager.js" defer></script> Disabled - conflicts with inline time blocking logic -->
    <script src="js/booking-modular.js" defer></script>

    <!-- Service Worker Registration -->
    <script>
        // Force cache refresh for development
        if ('caches' in window) {
            console.log('üîÑ Clearing caches to ensure latest version loads...');
            caches.keys().then(names => {
                names.forEach(name => {
                    console.log('üóëÔ∏è Deleting cache:', name);
                    caches.delete(name);
                });
            });
        }
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('üöÄ Service Worker registered');
                    
                    // Cache booking data for offline access
                    window.addEventListener('beforeunload', function() {
                        if (navigator.serviceWorker.controller) {
                            const bookingData = {
                                // Get current booking form data
                                service: document.querySelector('input[name="service"]:checked')?.value,
                                date: document.getElementById('date')?.value,
                                time: document.getElementById('time')?.value
                            };
                            
                            if (bookingData.service && bookingData.date && bookingData.time) {
                                navigator.serviceWorker.controller.postMessage({
                                    type: 'CACHE_BOOKING',
                                    booking: bookingData
                                });
                            }
                        }
                    });
                })
                .catch(error => console.log('‚ùå Service Worker registration failed:', error));
        }
        
        // Specific test for August 21st issue
        function testDate21st() {
            console.log('üéØ === TESTING AUGUST 21ST SPECIFICALLY ===');
            
            const dateInput = document.getElementById('date');
            if (dateInput) {
                console.log('üìÖ Setting date to 2025-08-21...');
                dateInput.value = '2025-08-21';
                
                console.log('üîÑ Triggering change event...');
                dateInput.dispatchEvent(new Event('change'));
                
                console.log('‚è≥ Waiting 1 second for processing...');
                setTimeout(() => {
                    console.log('üîç Checking results...');
                    
                    // Check what appointments exist for this date
                    const appointments = window.sharedAppointments || [];
                    const aug21Appointments = appointments.filter(apt => {
                        const normalized = normalizeDate(apt.date);
                        const target = normalizeDate('2025-08-21');
                        console.log(`Comparing: "${normalized}" vs "${target}"`);
                        return normalized === target;
                    });
                    
                    console.log('üìã Appointments for Aug 21:', aug21Appointments);
                    
                    // Check dropdown state
                    const timeSelect = document.getElementById('time');
                    if (timeSelect) {
                        console.log('üîç Current dropdown options:');
                        Array.from(timeSelect.options).forEach((option, index) => {
                            console.log(`  ${index}: "${option.textContent}" (disabled: ${option.disabled}, value: "${option.value}")`);
                        });
                    }
                    
                    alert(`August 21st Test Results:\n\nAppointments found: ${aug21Appointments.length}\nDropdown options: ${timeSelect ? timeSelect.options.length : 'N/A'}\n\nCheck console for details.`);
                }, 1000);
            } else {
                console.error('‚ùå Date input not found');
            }
        }
    </script>
</body>
</html>