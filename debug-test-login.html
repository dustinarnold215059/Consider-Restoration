<!DOCTYPE html>
<html>
<head>
    <title>Debug Test Login</title>
    <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
    <script>
        // Create compatibility wrapper for bcrypt
        setTimeout(() => {
            if (typeof dcodeIO !== 'undefined' && dcodeIO.bcrypt && !window.bcrypt) {
                window.bcrypt = dcodeIO.bcrypt;
                console.log('🔒 Created window.bcrypt reference to dcodeIO.bcrypt');
            }
        }, 100);
    </script>
    <script src="js/shared-data.js"></script>
    <script src="js/auth-security.js"></script>
    <script src="js/cookie-session-manager.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>Debug Test User Login</h1>
    
    <div>
        <button onclick="debugLogin()">Debug Login Process</button>
        <button onclick="testDirectAuth()">Test Direct Auth</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <div id="logs"></div>
    
    <script>
        function log(msg, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logsDiv.appendChild(logDiv);
            console.log(msg);
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        function debugLogin() {
            log('=== Starting Debug Login Process ===');
            
            // Check if all systems are loaded
            log(`CookieSessionManager available: ${typeof window.CookieSessionManager !== 'undefined'}`);
            log(`authenticateUser available: ${typeof window.authenticateUser !== 'undefined'}`);
            log(`verifyPassword available: ${typeof window.verifyPassword !== 'undefined'}`);
            log(`sharedUsers available: ${window.sharedUsers ? window.sharedUsers.length : 'N/A'} users`);
            
            if (window.sharedUsers) {
                const testUser = window.sharedUsers.find(u => u.email === 'test@test.com');
                if (testUser) {
                    log(`✅ Test user found: ${testUser.name}`, 'success');
                    log(`   - Email: ${testUser.email}`);
                    log(`   - Username: ${testUser.username}`);
                    log(`   - Password field: ${testUser.password}`);
                    log(`   - PasswordHash field: ${testUser.passwordHash}`);
                    log(`   - Role: ${testUser.role}`);
                } else {
                    log('❌ Test user NOT found in sharedUsers', 'error');
                    log('Available users:', 'info');
                    window.sharedUsers.forEach(u => {
                        log(`   - ${u.email || u.username} (${u.name})`);
                    });
                }
            }
            
            // Test authentication step by step
            log('=== Testing Authentication Steps ===');
            
            if (window.authenticateUser) {
                try {
                    log('Calling window.authenticateUser("test@test.com", "test123")...');
                    const result = window.authenticateUser('test@test.com', 'test123');
                    
                    if (result) {
                        log(`✅ Authentication SUCCESS: ${result.name}`, 'success');
                        log(`   - Email: ${result.email}`);
                        log(`   - Role: ${result.role}`);
                        
                        // Try to login with CookieSessionManager
                        if (window.CookieSessionManager) {
                            const loginResult = window.CookieSessionManager.login(result);
                            log(`CookieSessionManager login result: ${loginResult}`, loginResult ? 'success' : 'error');
                            
                            // Check if login persisted
                            setTimeout(() => {
                                const currentUser = window.CookieSessionManager.getCurrentUser();
                                if (currentUser) {
                                    log(`✅ Login persisted: ${currentUser.name}`, 'success');
                                } else {
                                    log('❌ Login did not persist', 'error');
                                }
                            }, 100);
                        } else {
                            log('❌ CookieSessionManager not available', 'error');
                        }
                    } else {
                        log('❌ Authentication FAILED', 'error');
                    }
                } catch (error) {
                    log(`❌ Authentication ERROR: ${error.message}`, 'error');
                }
            } else {
                log('❌ window.authenticateUser not available', 'error');
            }
        }
        
        function testDirectAuth() {
            log('=== Testing Direct Password Verification ===');
            
            const testUser = window.sharedUsers?.find(u => u.email === 'test@test.com');
            if (!testUser) {
                log('❌ Test user not found', 'error');
                return;
            }
            
            log(`Testing password verification for: ${testUser.name}`);
            log(`Password hash: ${testUser.passwordHash}`);
            
            if (window.verifyPassword) {
                try {
                    const result = window.verifyPassword('test123', testUser.passwordHash);
                    log(`Direct password verification: ${result ? 'SUCCESS' : 'FAILED'}`, result ? 'success' : 'error');
                } catch (error) {
                    log(`Password verification error: ${error.message}`, 'error');
                }
            } else {
                log('❌ verifyPassword function not available', 'error');
            }
            
            // Test bcrypt availability
            log('=== Testing Bcrypt Availability ===');
            log(`window.bcrypt: ${typeof window.bcrypt}`);
            log(`dcodeIO: ${typeof dcodeIO}`);
            if (typeof dcodeIO !== 'undefined') {
                log(`dcodeIO.bcrypt: ${typeof dcodeIO.bcrypt}`);
            }
        }
        
        // Auto-run debug when page loads
        setTimeout(() => {
            debugLogin();
        }, 1500);
    </script>
</body>
</html>